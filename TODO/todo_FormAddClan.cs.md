# План портирования FormAddClan.cs

Файл `FormAddClan.cs` реализует окно и логику для функции "массовое добавление всех членов клана в список контактов".

## Функциональность в C#

1.  **Инициация**: Пользователь указывает ник одного из членов клана, и запускается фоновый процесс `AddClanAsync`.
2.  **Получение списка клана**: Процесс обращается к внешнему сайту `allnl.ru`, находит там страницу нужного клана и парсит с нее полный список ников всех его членов.
3.  **Получение информации об игроках**: В цикле для каждого найденного ника делается запрос через `NeverApi.GetAll(nick)` для получения детальной информации (уровень, онлайн, травмы и т.д.).
4.  **Обновление UI**: В процессе работы форма в реальном времени отображает статус ("Анализируем [ник]...") и пополняет HTML-отчет с информацией о каждом добавленном игроке.
5.  **Добавление в контакты**: Каждый обработанный ник добавляется в основной список контактов приложения через вызов `AppVars.MainForm.AddContactFromBulk(...)`.

## Ключевые проблемы и зависимости

*   **Внешний ресурс**: Логика критически зависит от доступности и структуры сайта `allnl.ru`. Если этот сайт недоступен или его структура изменилась, функция работать не будет.
*   **`NeverApi`**: Зависит от некоего `NeverApi`, который также нужно будет найти и портировать.
*   **Асинхронность и UI**: Логика использует `ThreadPool` и `BeginInvoke` для взаимодействия с UI, что требует полной переработки под Android.

## План портирования на Android

Это сложная функция, требующая создания полноценного экрана и фоновой логики.

1.  **Проверка зависимостей**: **Первым шагом** необходимо проверить, доступен ли сайт `http://allnl.ru/clan-players/all` и актуальна ли на нем информация. Если нет, портирование этой функции в текущем виде бессмысленно.

2.  **UI (Activity/Fragment)**:
    *   Создать новый экран (например, `AddClanActivity`).
    *   Разметка должна содержать `RecyclerView` для отображения списка добавляемых игроков, `TextView` для отображения текущего статуса и, возможно, `ProgressBar`.

3.  **ViewModel (`AddClanViewModel.java`)**:
    *   Создать `ViewModel` для этого экрана.
    *   Он будет содержать:
        *   `LiveData<String> statusText`: для текста статуса.
        *   `LiveData<List<PlayerInfo>> addedPlayers`: для списка уже добавленных игроков.
    *   `Activity` будет подписана на эти `LiveData` и обновлять `TextView` и `RecyclerView` при их изменении.

4.  **Менеджер логики (`AddClanManager.java`)**:
    *   Создать класс, который инкапсулирует всю логику работы.
    *   **`public void startAdding(String nick, AddClanViewModel viewModel)`**: Основной метод, запускающий процесс.
    *   Внутри этого метода запустить корутину (`viewModelScope.launch`), которая будет выполнять все сетевые запросы и обработку в фоновом потоке.
    *   **Шаги в корутине**:
        1.  Обновить `statusText` на "Получение информации о клане...".
        2.  Сделать запрос к `allnl.ru`, скачать и распарсить HTML для получения списка ников.
        3.  Запустить цикл по списку.
        4.  В цикле: обновить `statusText` на "Анализируем [ник]...", сделать запрос через портированный `NeverApi`, добавить игрока в `ContactsManager` и обновить `LiveData` `addedPlayers`.
        5.  После завершения цикла обновить `statusText` на "Готово!".

5.  **Портирование `NeverApi`**: Найти и портировать класс `NeverApi` или его аналоги, отвечающие за получение информации об игроках.
