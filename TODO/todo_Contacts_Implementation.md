# Детальный план по реализации и отображению контактов

Этот документ описывает полный цикл работы с контактами: от получения данных с сервера до их отображения в списке контактов Android-приложения.

## 1. Модель данных контакта

Для хранения информации о контакте необходимо создать класс данных (data class в Kotlin), который будет включать все поля, получаемые от сервера.

```kotlin
data class Contact(
    val playerID: String,
    val nick: String,
    val playerLevel: Int,
    val inclination: Int,
    val inclinationName: String, // "Chaos", "Sumers", "Lights", "Darks", "0"
    val clanNumber: String,
    val clanIco: String,
    val clanName: String,
    val clanStatus: String,
    val gender: Int,
    val blockStatus: Int,
    val jailStatus: Int,
    val muteSeconds: Int,
    val muteForumSeconds: Int,
    val onlineStatus: Int, // 1 - online, 0 - offline
    val geoLocation: String,
    val warLogNumber: String // Может быть "0" или номер боя
)
```

## 2. Процесс добавления/обновления контакта

Процесс состоит из двух последовательных HTTP-запросов.

### Шаг 1: Получение ID персонажа

-   **Действие:** При добавлении нового контакта по нику, первым делом нужно получить его `playerID`.
-   **URL:** `http://www.neverlands.ru/modules/api/getid.cgi`
-   **Параметры:**
    -   `{nick}`: ник персонажа.
    -   Если ник содержит кириллические символы, он должен быть закодирован в URL-формат (percent-encoding).
-   **Пример:** `http://www.neverlands.ru/modules/api/getid.cgi?%D2%E5%F1%F2`
-   **Ответ сервера:** Строка формата `{playerID}|{nick}`.
-   **Пример ответа:** `123456|ТестовыйНик`
-   **Задача:** Распарсить ответ и извлечь `playerID`.

### Шаг 2: Получение полной информации о персонаже

-   **Действие:** Используя `playerID` из Шага 1, сделать запрос для получения полной информации.
-   **URL:** `http://www.neverlands.ru/modules/api/info.cgi`
-   **Параметры:**
    -   `playerid`: ID, полученный на предыдущем шаге.
    -   `info`: `1`
-   **Пример:** `http://www.neverlands.ru/modules/api/info.cgi?playerid=123456&info=1`
-   **Ответ сервера:** Строка с разделителем `|`.
-   **Формат ответа:** `3|[nick]|[PlayerLevel]|[inclination]|[clanNumber]|[clanIco]|[clanName]|[clanStatus]|[gender]|[blockStatus]|[jailStatus]|[muteSeconds]|[muteForumSeconds]|[onlineStatus]|[geoLocation]|[warLogNumber]`
-   **Задача:** Распарсить эту строку и заполнить все поля модели данных `Contact` из пункта 1.

## 3. Визуальное представление контакта в списке

Каждый элемент в списке контактов (например, в `RecyclerView`) должен состоять из следующих элементов в указанном порядке:

1.  **Индикатор онлайна:**
    -   **Логика:** Если `onlineStatus == 1`, отображается круглый зеленый значок. Если `onlineStatus == 0`, отображается круглый красный значок.

2.  **Иконка склонности (`inclination`):**
    -   **Логика:** В зависимости от значения поля `inclination`, отображается соответствующая иконка.
    -   `4`: `http://image.neverlands.ru/signs/chaoss.gif` (Chaos)
    -   `3`: `http://image.neverlands.ru/signs/sumers.gif` (Sumers)
    -   `2`: `http://image.neverlands.ru/signs/lights.gif` (Lights)
    -   `1`: `http://image.neverlands.ru/signs/darks.gif` (Darks)
    -   `0`: Иконка не отображается.

3.  **Иконка клана (`clanIco`):**
    -   **Логика:** Если поле `clanIco` не пустое, отображается иконка по URL.
    -   **URL:** `http://image.neverlands.ru/signs/[clanIco]`

4.  **Ссылка на бой "в бою":**
    -   **Логика:** Если `warLogNumber` больше `0`, отображается текстовая надпись "в бою".
    -   **Действие:** Эта надпись является ссылкой, которая открывает новое окно/Activity с WebView по адресу `http://neverlands.ru/logs.fcg?fid={warLogNumber]`.
    -   Если `warLogNumber` равен `0`, надпись не отображается.

5.  **Ник персонажа (`nick`):**
    -   **Логика:** Отображается текстовое поле с ником персонажа.

6.  **Иконка информации о персонаже:**
    -   **Логика:** После ника отображается стандартная иконка "информация".
    -   **Действие:** Нажатие на эту иконку открывает информацию о персонаже (например, `pinfo.cgi?{nick}`).

## 4. План реализации (Задачи)

-   [ ] **1. Модель данных:**
    -   [ ] Создать data class `Contact` в соответствующем пакете (`data` или `model`).

-   [ ] **2. Сетевой слой (API Service):**
    -   [ ] Реализовать метод для запроса `getid.cgi`, который принимает `nick` и возвращает `playerID`. Не забыть про URL-кодирование.
    -   [ ] Реализовать метод для запроса `info.cgi`, который принимает `playerID` и возвращает строку с полной информацией.
    -   [ ] Создать парсер для строки ответа от `info.cgi`, который преобразует ее в объект `Contact`.

-   [ ] **3. Репозиторий/Менеджер контактов (`ContactsManager`):**
    -   [ ] Создать класс, отвечающий за логику работы с контактами.
    -   [ ] Реализовать метод `addContact(nick: String)`, который последовательно выполняет запросы `getid.cgi` и `info.cgi`, создает объект `Contact` и сохраняет его.
    -   [ ] Реализовать методы для сохранения, загрузки и обновления списка контактов (локально, например, в БД Room или SharedPreferences).

-   [ ] **4. UI - Адаптер списка (`ContactsAdapter` для `RecyclerView`):**
    -   [ ] Создать XML-файл разметки для одного элемента списка (`contact_list_item.xml`), содержащий все необходимые `ImageView` и `TextView`.
    -   [ ] Создать `ContactsAdapter` и `ContactViewHolder`.
    -   [ ] В методе `onBindViewHolder` адаптера реализовать всю логику отображения из пункта 3:
        -   [ ] Установка цвета индикатора онлайна.
        -   [ ] Загрузка иконки склонности (используя Glide/Picasso).
        -   [ ] Загрузка иконки клана.
        -   [ ] Управление видимостью и настройка обработчика клика для ссылки "в бою".
        -   [ ] Установка текста ника.
        -   [ ] Настройка обработчика клика для иконки информации.

-   [ ] **5. Интеграция с UI:**
    -   [ ] Связать UI добавления контакта (диалог или поле ввода) с вызовом метода `ContactsManager.addContact(nick)`.
    -   [ ] Обеспечить обновление `RecyclerView` после добавления или обновления контакта.
    -   [ ] Загружать и отображать список контактов при запуске экрана.
