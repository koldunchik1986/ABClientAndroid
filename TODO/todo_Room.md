# Задача: Отображение персонажей и кнопок действий в комнате

**Статус:** `[ ] Не реализована`

**История:** Изначально персонажи в комнате не отображались. Проблема считалась нерешенной.

**Прорыв (2025-10-02):** В ходе отладки другой проблемы (`NoClassDefFoundError`), был временно отключен `CustomWebViewClient` в `MainActivity`. Это неожиданно привело к тому, что список персонажей в комнате **начал отображаться**. Кнопки действий (атаки и т.д.) при этом отсутствуют.

## Анализ

Отключение `CustomWebViewClient` доказывает, что проблема была в его методе `shouldInterceptRequest`. Этот метод перехватывал сетевые запросы и, по-видимому, повреждал или некорректно изменял HTML/JS код, возвращаемый сервером для фрейма комнаты.

- **Почему персонажи появились:** `WebView` теперь использует свой стандартный загрузчик, который корректно получает и отображает базовый HTML со списком персонажей.
- **Почему кнопок нет:** Кнопки действий, скорее всего, создаются динамически через JavaScript (`ch_list.js`), который ранее "внедрялся" через `shouldInterceptRequest`. Так как перехватчик отключен, скрипты и необходимые для них данные (например, `ChatListU`) больше не добавляются на страницу.

## План решения

Необходимо полностью переписать логику `shouldInterceptRequest`

- [ ] **Шаг 1: Исправить синтаксическую ошибку в `ch_list.js`**
  - **Проблема:** В логах все еще присутствует ошибка `Uncaught SyntaxError: missing ) after argument list` в строке 156. Пока мы ее не исправим, внедрение этого скрипта бессмысленно.
  - **Действие:** Найти и исправить ошибку в файле `ABClient/ch_list.js`.

- [ ] **Шаг 2: Создать "чистый" `WebViewClient`**
  - **Действие:** Раскомментировать `webView.setWebViewClient(client);`.
  - **Действие:** Полностью **удалить все содержимое** метода `shouldInterceptRequest` в `MainActivity.java`, оставив только `return super.shouldInterceptRequest(view, request);`. Это вернет нам работающий `WebView`, но со стандартным поведением.

- [ ] **Шаг 3: Аккуратно вернуть внедрение Cookies**
  - **Гипотеза:** Cookies необходимы для аутентификации и получения данных для кнопок действий.
  - **Действие:** Написать в `shouldInterceptRequest` минималистичную логику, которая будет только добавлять необходимые `Cookie` к исходящим запросам, не трогая тело ответа.

- [ ] **Шаг 4: Вернуть внедрение `ch_list.js`**
  - **Действие:** После исправления ошибки в Шаге 1, добавить в `shouldInterceptRequest` логику для перехвата запроса к `ch_list.js` и добавления к нему JS-моста (`window.external = window.AndroidBridge;`) и массива `ChatListU`.

- [ ] **Шаг 5: Проверить и отказаться от принудительной кодировки**
  - **Гипотеза:** Принудительная установка кодировки `windows-1251` может быть одной из причин повреждения данных.
  - **Действие:** На всех этапах стараться не использовать `.getBytes("windows-1251")`, позволяя `WebView` самому определять кодировку. Вернуть эту логику только в крайнем случае, если без нее возникнут проблемы.
