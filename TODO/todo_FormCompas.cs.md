# План портирования FormCompas.cs

Файл `FormCompas.cs` реализует окно и логику для функции "Компас" — сканирования местоположения всех членов клана.

## Функциональность в C#

Логика этого модуля очень похожа на `FormAddClan.cs`, но с фокусом на геолокации.

1.  **Инициация**: Пользователь указывает ник одного из членов клана.
2.  **Получение списка клана**: Используя ник, скрипт обращается к внешнему сайту `allnl.ru` и парсит оттуда полный список всех соклановцев.
3.  **Определение местоположения**: В цикле для каждого члена клана:
    *   Через `NeverApi.GetAll(nick)` получается его текущая локация в виде строки (например, "Лес Чудес").
    *   Если игрок оффлайн, это указывается в отчете.
    *   Если игрок онлайн, скрипт выполняет поиск по своей внутренней базе карты (`Map.Cells`):
        *   Находятся все клетки, название которых совпадает с локацией игрока.
        *   С помощью `MapPath` (алгоритма поиска пути) вычисляется кратчайший маршрут от текущего положения игрока до каждой из этих возможных клеток.
    *   В итоговый отчет для этого игрока выводится информация о ближайшей возможной клетке и количестве шагов до нее.
4.  **Обновление UI**: Форма в реальном времени отображает статус сканирования и HTML-отчет с никами, иконками и рассчитанным местоположением.

## Ключевые проблемы и зависимости

*   **`ExtMap`**: Модуль критически зависит от всей системы `ExtMap` (`Map`, `MapPath`, `Cell`), которая содержит граф карты мира и алгоритмы для поиска пути. Без портирования `ExtMap` эта функция неработоспособна.
*   **Внешний ресурс `allnl.ru`**: Как и `FormAddClan`, зависит от доступности и структуры этого сайта.
*   **`NeverApi`**: Требует портирования API для получения информации об игроках.

## План портирования на Android

Это сложная функция, портирование которой должно происходить после реализации базовой навигационной системы.

**Статус: БЛОКИРОВАНО.** Портировать только после `ExtMap` и `NeverApi`.

1.  **UI (`CompasActivity.java`)**:
    *   Создать новый экран с `RecyclerView` для отображения списка соклановцев и их местоположения.

2.  **ViewModel (`CompasViewModel.java`)**:
    *   Создать `ViewModel` с `LiveData<List<ClanMemberLocation>>` для хранения и отображения результатов сканирования.
    *   `ClanMemberLocation` — новый data-класс, содержащий поля: `nick`, `level`, `isOnline`, `locationName`, `closestCell`, `steps`.

3.  **Менеджер логики (`CompasManager.java`)**:
    *   Создать класс, инкапсулирующий логику сканирования.
    *   **`public void startScan(String nick, CompasViewModel viewModel)`**: Метод, запускающий корутину для выполнения всей работы в фоновом потоке.
    *   **Шаги в корутине**:
        1.  Получить список клана с `allnl.ru`.
        2.  В цикле для каждого ника:
            a. Получить `userInfo` через портированный `NeverApi`.
            b. Если игрок онлайн, получить его `locationName`.
            c. Вызвать портированный `MapPath` для поиска ближайшей клетки и количества шагов: `new MapPath(currentUserLocation, possibleCells)`. 
            d. Создать объект `ClanMemberLocation` с результатами.
            e. Добавить объект в список и обновить `LiveData` в `ViewModel`.
