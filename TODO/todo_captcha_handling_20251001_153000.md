# План реализации поддержки CAPTCHA при авторизации

## 1. Анализ функциональности (на основе Login.har)

Сервер `neverlands.ru` ввел дополнительный шаг безопасности при частых попытках входа: проверку CAPTCHA. Стандартный процесс авторизации теперь является двухэтапным.

### Функциональность в браузере (HAR)

1.  **Шаг 1: Первый POST-запрос**
    *   **URL:** `http://neverlands.ru/game.php`
    *   **Метод:** `POST`
    *   **Тело запроса (`application/x-www-form-urlencoded`):**
        *   `player_nick`: (имя пользователя)
        *   `player_password`: (пароль)
    *   **Результат:** Если сервер подозревает бота, он возвращает `200 OK` с HTML-страницей. Эта страница содержит:
        *   Картинку CAPTCHA.
        *   Форму для ввода цифр с картинки.
        *   Скрытое поле (hidden input) с именем `vcode` и уникальным значением (например, `d68d086acbdd9050d75be8d2739bad37`).

2.  **Шаг 2: Второй POST-запрос (с CAPTCHA)**
    *   **URL:** `http://neverlands.ru/game.php`
    *   **Метод:** `POST`
    *   **Тело запроса (`application/x-www-form-urlencoded`):**
        *   `vcode`: значение из скрытого поля с предыдущего шага.
        *   `player_nick`: (имя пользователя)
        *   `player_password`: (пароль)
        *   `verify`: цифры, которые пользователь ввел с картинки.
    *   **Результат:** В случае успеха сервер возвращает `200 OK` и HTML-страницу с фреймами игры (`main.php`, `ch.php` и т.д.), устанавливая необходимые сессионные cookies.

## 2. Решение для портирования на Android

Поскольку автоматическое распознавание CAPTCHA невозможно, необходимо модифицировать `AuthManager` и UI, чтобы позволить пользователю вручную вводить код с картинки.

Логика должна быть следующей:
1.  `AuthManager` выполняет первый POST-запрос.
2.  Он анализирует ответ. Если ответ содержит `auth_form` — это ошибка пароля. Если ответ содержит `vcode` и упоминание капчи — это запрос на ввод капчи.
3.  В случае запроса капчи, `AuthManager` должен извлечь URL картинки и значение `vcode`.
4.  `AuthManager` возвращает специальный callback в `LoginActivity`, указывающий на необходимость показать диалог ввода капчи.
5.  `LoginActivity` отображает диалоговое окно, в котором показывает картинку CAPTCHA и поле для ввода.
6.  После ввода, `LoginActivity` снова вызывает `AuthManager`, передавая ему `vcode` и введенный пользователем `verify` код.
7.  `AuthManager` выполняет второй POST-запрос со всеми четырьмя параметрами.
8.  В случае успеха, `onSuccess` вызывается как обычно.

## 3. План реализации

-   [ ] **Модифицировать `AuthManager.java`**
    -   [ ] В методе `authorize` добавить логику анализа ответа от первого POST-запроса.
    -   [ ] Определить критерий для распознавания страницы с CAPTCHA (например, по наличию инпута с именем `vcode`).
    -   [ ] Создать новый метод в `AuthCallback` (например, `onCaptchaRequired(String captchaImageUrl, String vcode)`).
    -   [ ] Создать новый публичный метод в `AuthManager` (например, `authorizeWithCaptcha(String vcode, String verify, ...)`) для выполнения второго POST-запроса.
    -   [ ] При вызове `onCaptchaRequired`, `AuthManager` должен парсить HTML, извлекать `vcode` и полный URL картинки с капчей.

-   [ ] **Модифицировать `LoginActivity.java`**
    -   [ ] Реализовать новый метод `onCaptchaRequired` в `AuthCallback`.
    -   [ ] Создать кастомное диалоговое окно (`AlertDialog` или `DialogFragment`).
    -   [ ] В диалоговом окне разместить `ImageView` для загрузки картинки по URL и `EditText` для ввода кода.
    -   [ ] При нажатии "ОК" в диалоге, вызывать новый метод `AuthManager.authorizeWithCaptcha`, передавая все необходимые данные.

-   [ ] **Обработка кодировок и cookies**
    -   [ ] Убедиться, что все POST-запросы отправляются в кодировке `windows-1251`.
    -   [ ] Убедиться, что `OkHttpClient` использует `WebViewCookieJar` для автоматической сквозной передачи cookies между всеми шагами авторизации и последующими запросами в `WebView`.

-   [ ] **Тестирование**
    -   [ ] Проверить сценарий успешного логина без капчи.
    -   [ ] Проверить сценарий с неверным паролем.
    -   [ ] Проверить сценарий с появлением капчи и ее правильным вводом.
    -   [ ] Проверить сценарий с появлением капчи и ее неправильным вводом.
