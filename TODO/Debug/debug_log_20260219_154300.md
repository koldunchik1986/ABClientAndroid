# Debug Log: FastAction — Свитки/Нападалки не работают

**Дата:** 2026-02-19
**Билд:** v1.1.0 (abclient_v1.1.0.apk)

## Описание проблемы

При нажатии быстрого действия (нападалка/свиток) из QuickActionsBottomSheet:
- WebView переходит на страницу инвентаря
- Но свиток не находится и не используется
- Действие завершается с `result=null`

## Анализ логов (logcat 2026-02-19 15:43)

### Хронология событий

```
15:43:31 MainPhp: process() main.php?get_id=56&act=10&go=inf&vcode=117fd19e → 16340 bytes
         (Обычная загрузка страницы персонажа)

15:43:41 FastActionManager: fastStart: id=i_svi_001.gif, nick=Блудя, count=1
15:43:41 FastActionManager: reloadMainFrame: loading main.php?get_id=56&act=10&go=inv&im=0&wca=28
         (URL БЕЗ vcode — VCode пуст или устарел)

15:43:41 WebViewInterceptor: Intercepting: main.php?get_id=56&act=10&go=inv&im=0&wca=28
15:43:41 WebViewInterceptor: Raw bytes: 16340
         (Сервер вернул 16340 bytes — это go=inf, НЕ инвентарь!)
         (Без vcode сервер игнорирует go=inv и wca=28)

15:43:41 MainPhp: process() → FastNeed=true
15:43:41 FastActionManager: processMainPhp: w28_form=false
         (Нет w28_form — мы не на инвентаре)

15:43:41 FastActionManager: findTargetLink: ищем wca=28 → НЕ НАЙДЕНО
15:43:41 FastActionManager: findTargetLink: найдена ссылка на общий инвентарь:
         main.php?get_id=56&act=10&go=inv&vcode=69b32cd4a19363fa93d1b2481a4686ba
         (Нашли ссылку с vcode и делаем редирект)

15:43:42 WebViewInterceptor: Intercepting: main.php?get_id=56&act=10&go=inv&vcode=69b32cd4...
15:43:42 WebViewInterceptor: Raw bytes: 676494
         (Теперь получили полный инвентарь 676K)

15:43:42 MainPhp: process() → FastNeed=true
15:43:42 FastActionManager: processMainPhp: w28_form=true
         (w28_form есть! Но...)

15:43:42 FastActionManager: обычную нападалку не найдена в HTML
         (mainPhpFastHit НЕ нашел wsubid 1/2/3/4 среди w28_form вызовов)

15:43:42 FastActionManager: findTargetLink: ищем wca=28 → НЕ НАЙДЕНО в 676K HTML
         (В полном инвентаре нет ссылки на категорию wca=28)

15:43:42 FastActionManager: processMainPhp: НЕУДАЧА, result=null
```

### Корневая причина

**Проблема многоуровневая:**

1. **VCode пуст при первом запросе.** `AppVars.VCode` не обновляется или пуст на момент вызова `getInventoryUrl()`. Без vcode сервер игнорирует `go=inv` и `wca=28`.

2. **Полный инвентарь (go=inv без wca) — 676K — содержит w28_form, но НЕ для обычных нападалок.** w28_form с wsubid 1-4 видны только на фильтрованной странице `wca=28` (категория "Свитки"). На странице полного инвентаря w28_form вызовы относятся к другим типам предметов.

3. **Архитектурное несоответствие с C#.** В C# FastAction обрабатывается **внутри** `MainPhp.cs` (строки 1429-1619), а не в отдельном менеджере. Алгоритм C#:
   - `MainPhp` проверяет `FastNeed=true`
   - Вызывает `MainPhpFindInv(html, "&im=0&wca=28")` — ищет ссылку на инвентарь с нужным vcode В ТЕКУЩЕМ HTML
   - Возвращает `BuildRedirect(...)` — HTML с `<script>window.location='...'</script>`
   - Браузер/WebView автоматически переходит по ссылке
   - На следующем проходе `MainPhpIsInv(html)=true` → вызывает `MainPhpFast(html)` для поиска свитка
   - Если свиток не найден И мы не на `wca=28` — делает `BuildRedirect("main.php?im=0&wca=28")`
   - На следующем проходе `MainPhpFast` находит свиток и генерирует форму

4. **Ключевое отличие:** C# клиент работает через прокси, **каждый ответ** проходит через Filter. `BuildRedirect` генерирует redirect-HTML, браузер его исполняет, делает новый запрос, который снова попадает в Filter. На Android — `loadUrl(url)` заменяет **весь frameset**, а redirect через `<script>location=...</script>` из interceptor работает аналогично.

## Решение

Нужно портировать логику из C# `MainPhp.cs` (строки 1429-1619):

1. **BuildRedirect** (Filter.cs:280-291) — генерирует HTML: `<script>window.location='url'</script>`
2. **MainPhpFindInv** (MainPhpDrink.cs:86-219) — ищет vcode для ссылки на инвентарь в текущем HTML
3. **MainPhpIsInv** (MainPhpDrink.cs:221-224) — проверяет, что мы на странице инвентаря (`<a href="?im=0"><img`)
4. **Интегрировать в MainPhp.process()** — обработка FastAction должна быть в MainPhp, а не через отдельный reloadMainFrame()

### Алгоритм (из C#):
```
if (FastNeed) {
    // Определяем нужную вкладку
    String filter = isScroll ? "&im=0&wca=28" : "&im=0&wca=27";

    // 1. Если мы НЕ на инвентаре — ищем ссылку на инвентарь в HTML
    String invHtml = MainPhpFindInv(html, filter);
    if (invHtml != null) return invHtml;  // BuildRedirect на инвентарь

    // 2. Если мы НА инвентаре — ищем предмет
    if (MainPhpIsInv(html)) {
        String fastHtml = MainPhpFast(html);
        if (fastHtml != null) return fastHtml;  // Форма с авто-submit

        // 3. Предмет не найден — может мы на неправильной вкладке?
        if (!address.endsWith(filter)) {
            return BuildRedirect("main.php?" + filter);  // Переход на нужную вкладку
        }

        // 4. Мы на правильной вкладке, но предмет не найден — отмена
        FastCancel();
    }
}
```

## Действия

- [ ] Портировать `BuildRedirect` в Android (MainPhp.java или HtmlUtils.java)
- [ ] Портировать `MainPhpFindInv` и `MainPhpIsInv` в MainPhp.java
- [ ] Перенести обработку FastAction из `FastActionManager.processMainPhp()` в `MainPhp.process()`
- [ ] Убрать `reloadMainFrame()` с прямым URL — вместо этого C# навигирует через `NavigateFrame("main_top", "main.php")`, которая загружает plain main.php в sub-frame. На Android это `loadUrl` + interceptor
- [ ] Тестирование: fastStart → MainPhp обрабатывает первый ответ → redirect на инвентарь → MainPhp обрабатывает второй ответ → find item → auto-submit
