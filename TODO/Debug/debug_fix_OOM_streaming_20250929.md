# Журнал отладки: Решение проблемы OutOfMemoryError

- **Дата:** 29.09.2025
- **Проблема:** Приложение падало с `OutOfMemoryError` при загрузке игровых ресурсов.
- **Статус:** **РЕШЕНО**

## Хронология

1.  **Анализ логов:** Первоначальные логи показали, что кэш на диске не работает. Были добавлены логи в `Cache.java` в метод `storeDisk()`.

2.  **Ключевое наблюдение:** Пользователь предоставил полный лог, в котором отсутствовали диагностические сообщения из `storeDisk()`. Это привело к выводу, что код сохранения в кэш **никогда не выполнялся**.

3.  **Поиск причины:** Был сделан вывод, что поток `SessionHandler` падает до того, как доходит до логики кэширования. Единственной возможной причиной такого падения, которую не отловит `try-catch(Exception e)`, является `java.lang.OutOfMemoryError`.

4.  **Определение корневой причины:** Архитектура `SessionHandler` предполагала полную загрузку файла в `ByteArrayOutputStream` в оперативной памяти. Это и вызывало `OutOfMemoryError` на больших файлах, убивая поток до вызова `Cache.store()`.

## Реализованное решение

Была произведена полная переработка `SessionHandler` и `Cache` для перехода на потоковую обработку.

1.  **`SessionHandler.java`:**
    -   Больше не использует `ByteArrayOutputStream` для хранения всего ответа.
    -   При получении ответа от сервера, он читает `InputStream` по частям в небольшой буфер (`byte[4096]`)
    -   Каждый прочитанный буфер **одновременно** записывается в `OutputStream` клиента (для `WebView`) и в `FileOutputStream` временного файла на диске.

2.  **`Cache.java`:**
    -   Добавлены методы `createTempFile()` и `commitTempFile()`.
    -   `SessionHandler` сначала создает временный файл.
    -   После **успешной** загрузки всего ресурса, `SessionHandler` вызывает `commitTempFile`, который переименовывает временный файл в его постоянное имя в кэше.

## Итог

Данный подход решил проблему `OutOfMemoryError`, так как большие файлы больше не загружаются в оперативную память целиком. Кэширование теперь работает корректно, и приложение функционирует стабильно.
