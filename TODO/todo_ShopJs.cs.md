# План портирования ShopJs.cs

Файл `ShopJs.cs` является частью `PostFilter` и ключевым элементом механизма **массовой продажи** вещей в государственном магазине.

## Функциональность в C#

Фильтр модифицирует основной JavaScript-файл магазина (`/js/shop.js`). Он находит callback-функцию, которая выполняется после каждого AJAX-запроса (включая запросы на продажу), и внедряет в нее свой код.

*   **Внедряемый код**:
    ```javascript
    var arg1 = window.external.BulkSellOldArg1();
    var arg2 = window.external.BulkSellOldArg2();
    if (arg1 > 0) shop_item_sell(arg1, arg2);
    ```

**Назначение и принцип работы:**

Этот код создает цикл асинхронных продаж:

1.  Пользователь нажимает кнопку "Продать все" (добавленную фильтром `ShopAjaxPhp.cs`).
2.  В Java-коде (через `AndroidBridge`) устанавливается флаг начала массовой продажи.
3.  Продается первая вещь из пачки.
4.  Сервер присылает ответ, клиент его обрабатывает, и затем выполняется callback-функция, в которую мы внедрили наш код.
5.  Наш код обращается к `window.external` (`AndroidBridge`).
6.  Java-код проверяет, активен ли режим массовой продажи. Если да, он возвращает параметры для продажи **следующей** вещи из пачки.
7.  JS-код получает эти параметры и немедленно вызывает `shop_item_sell(...)` еще раз.
8.  Цикл повторяется, пока Java-код не вернет `0`, сигнализируя, что все вещи из пачки проданы.

## План портирования в Android

Эту логику необходимо портировать для реализации массовой продажи.

1.  **Создать `ShopJs.java`**: В пакете `ru.neverlands.abclient.postfilter`.
2.  **Реализовать метод `process`**:
    *   Выполнить замену строки, как в C#-версии, но с использованием `AndroidBridge`.
3.  **Создать `BulkSellManager.java`**:
    *   Это будет новый класс-менеджер (синглтон), отвечающий за состояние массовой продажи.
    *   Он будет хранить флаг `isBulkSelling`, а также параметры для продажи (ID вещи, vcode и т.д.).
    *   Метод `start(name, price)` будет вызываться из `WebAppInterface`, когда пользователь нажимает "Продать все".
    *   Методы `getNextArg1()` и `getNextArg2()` будут возвращать параметры для следующей продажи или `0`/`null`, если продажа завершена.
4.  **Реализовать методы в `WebAppInterface`**:
    *   Создать методы, которые будут вызываться из JS:
        ```java
        @JavascriptInterface
        public int BulkSellOldArg1() {
            return BulkSellManager.getInstance().getNextArg1();
        }

        @JavascriptInterface
        public String BulkSellOldArg2() {
            return BulkSellManager.getInstance().getNextArg2();
        }
        ```
5.  **Интегрировать в `Filter.java`**: Добавить вызов `ShopJs.process(array)` для соответствующего URL.
