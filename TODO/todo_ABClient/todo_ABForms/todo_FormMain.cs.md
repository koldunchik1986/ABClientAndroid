
### 1. План портирования FormMain.cs и его partial-классов

`FormMain` является "божественным объектом" (God Object) всего C# приложения. Он разбит на множество `partial`-классов, каждый из которых отвечает за определенную часть функциональности, но все они тесно связаны и работают с общими UI-компонентами и глобальными переменными. Портирование требует полной реархитектуры и разделения на компоненты, соответствующие современным практикам Android.

### 2. Функциональность в C#

- **Центральный узел:** Управляет главным окном, всеми вкладками, панелями, меню и статус-баром.
- **Обработка событий:** Содержит сотни обработчиков событий от UI-элементов.
- **Управление состоянием:** Напрямую читает и пишет в глобальный объект `AppVars`.
- **DOM-манипуляции:** Активно работает с DOM-деревом `WebBrowser` для извлечения данных и выполнения действий.
- **Фоновые задачи:** Запускает задачи в `ThreadPool` и обновляет UI через `BeginInvoke`.
- **Ключевые модули:** Включает в себя логику для чата, контактов, автобоя, навигатора, системы вкладок, таймеров, системного трея и многого другого.

### 3. Решение для портирования на Android

Монолитный `FormMain` должен быть декомпозирован на стандартные компоненты Android: `Activity`, `Fragment`, `ViewModel`, `Repository` и `Service`.

- **`MainActivity.kt`:** Будет служить основным контейнером. Ее роль — управлять глобальными элементами навигации (например, `DrawerLayout`, `BottomNavigationView` или `TabLayout` для основных разделов) и быть хостом для `Fragment`'ов. Вся сложная логика должна быть вынесена из `Activity`.
- **`ViewModel`'и для каждой функции:** Вместо одного гигантского класса, для каждого основного функционального блока должен быть создан свой `ViewModel`:
    - `MainViewModel`: Для глобального состояния (информация о пользователе, статус соединения).
    - `ChatViewModel`: Для логики и состояния чата.
    - `ContactsViewModel`: Для списка контактов и их состояний.
    - `NavigatorViewModel`: Для управления состоянием авто-навигации.
    - `FightViewModel`: Для управления состоянием автобоя.
- **`Repository` для данных:** Вся работа с данными (сеть, БД, скрейпинг) должна быть инкапсулирована в классах-репозиториях:
    - `UserRepository`, `ContactsRepository`, `MapRepository`, `ClanRepository` и т.д.
- **`Service` и `WorkManager` для фона:**
    - Логика из `TimerCrap` (периодические проверки состояния персонажа) должна быть перенесена в `WorkManager`, который будет выполнять эти задачи по расписанию, даже если приложение не на переднем плане.
    - Постоянное соединение с чатом может поддерживаться в `Foreground Service`.
- **Замена DOM-манипуляций:**
    - **Извлечение данных:** Использовать `JavascriptInterface` для сбора данных со страницы в JSON-объект.
    - **Выполнение действий:** Использовать `OkHttp`/`Retrofit` для прямых POST/GET запросов к серверу вместо `InvokeScript`.

### 4. План реализации

Портирование `FormMain` — это, по сути, создание всего Android-приложения. План должен быть разбит на этапы портирования каждого модуля:

1.  **Создать базовую архитектуру `MainActivity`:**
    - [ ] Настроить `Toolbar`, `DrawerLayout`.
    - [ ] Реализовать систему навигации между основными экранами (фрагментами), такими как "Игра", "Контакты", "Настройки".
2.  **Портировать систему вкладок (`FormMainTabs`):**
    - [ ] Реализовать `ViewPager2` с `FragmentStateAdapter` для управления вкладками с `WebView`, как описано в анализе папки `Tabs`.
3.  **Портировать Чат (`FormMainChat`):**
    - [ ] Создать `ChatFragment` и `ChatViewModel`.
    - [ ] Вместо парсинга HTML в коде клиента, использовать `RecyclerView` для отображения сообщений.
    - [ ] Логику форматирования и добавления информации об игроках перенести во `ViewModel`.
4.  **Портировать Контакты (`FormMainContacts`):**
    - [ ] Создать `ContactsFragment` и `ContactsViewModel`.
    - [ ] Заменить `TreeView` на `RecyclerView` с поддержкой вложенности или группами.
5.  **Портировать Автобой (`FormMainAutoBoi`):**
    - [ ] Создать `FightViewModel`, который будет использовать `FightDecisionEngine` (из анализа `Lez`).
    - [ ] Логика запуска хода (`AutoTurn`) будет вызывать `FightActionExecutor` (HTTP-клиент).
6.  **Портировать Навигатор (`FormMainNavigator`):**
    - [ ] Создать `NavigatorViewModel`.
    - [ ] Интегрировать его с портированным алгоритмом A* (`MapPathfinder`) и `MapRepository`.
7.  **Портировать фоновые проверки (`FormMainTicks`, `FormMainCheckInfo`):**
    - [ ] Создать `PeriodicWorkRequest` с помощью `WorkManager` для регулярной проверки состояния персонажа через `NeverApi`.
8.  **Портировать системный трей (`FormMainTray`):**
    - [ ] Заменить на систему `Notification`.
    - [ ] Создать `NotificationHelper` для управления уведомлениями (о сообщениях, капче и т.д.).

- [ ] Создать базовую `MainActivity` с навигацией.
- [ ] Последовательно портировать каждый логический модуль (`Chat`, `Contacts`, `AutoBoi` и т.д.) в связку `Fragment + ViewModel + Repository`.
- [ ] Заменить все прямые манипуляции с DOM на `JavascriptInterface` и `OkHttp`.
- [ ] Заменить `ThreadPool` и `Timer` на `Coroutines` и `WorkManager`.
