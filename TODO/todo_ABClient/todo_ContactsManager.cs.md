# План портирования ContactsManager.cs

**Статус портирования:**
Контакты реализованы в Android в модернизированном виде. Портирование "один в один" не требуется. Допускается только корректировка имён переменных и методов для соответствия C#, без изменения логики.

**Расположение TODO-файла соответствует алгоритму: исходный ContactsManager.cs находится в корне ABClient, поэтому todo_ContactsManager.cs.md размещён в корне TODO/todo_ABClient/.**

Файл `ContactsManager.cs` - это большой статический класс, который является центром управления всеми контактами, их отображением и процессом мониторинга.

## Функциональность в C#

*   **Назначение**: Управляет жизненным циклом контактов: загружает, сохраняет, добавляет, удаляет, обновляет их отображение в UI (`TreeView`) и, что самое главное, координирует процесс их периодического мониторинга.
*   **Управление UI**: Тесно связан с `System.Windows.Forms.TreeView`. Содержит логику для создания узлов (`TreeNode`), группировки контактов (по клану, статусу), обновления иконок, цвета и текста узла в зависимости от состояния контакта (онлайн, в бою, травмы).
*   **Мониторинг (`Pulse()`)**: Реализует эффективный механизм мониторинга. Вместо того чтобы проверять всех подряд, `Pulse` находит один контакт, чье время следующей проверки (`NextCheck`) самое раннее, и ставит в очередь (`ThreadPool`) задачу только для него. Это снижает нагрузку на сеть и процессор.
*   **Обработка контактов**: В фоновом потоке (`ProcessAsync`) вызывает `NeverApi.GetAll()` для получения `UserInfo`, а затем передает его в метод `contact.Process()`, где и происходит вся детальная логика анализа изменений.
*   **Управление Боссами**: Содержит отдельную логику для загрузки, сохранения и обработки "контактов боссов" из `bossusers.xml`.
*   **Потокобезопасность**: Использует `ReaderWriterLock` для защиты всех операций, связанных с коллекциями контактов и обновлением UI.

## Проверка на существующую реализацию в Android

- **Результат аудита:** В Android-версии полностью отсутствует ContactsManager и вся система мониторинга, хранения и отображения контактов, включая Pulse, TreeView/RecyclerView, работу с bossusers.xml и потокобезопасность. Нет ни класса, ни адаптера, ни фоновой службы. Требуется полный перенос всей логики из C#.

## Решение для портирования на Android

Это одна из ключевых функций клиента. Ее портирование потребует создания нескольких компонентов: менеджера-синглтона, фоновой службы для выполнения `Pulse`, адаптера для отображения списка контактов и портирования всех зависимостей.

## План реализации

- [ ] **Создать `ContactsManager.java`** в пакете `ru.neverlands.abclient.manager`.
    - [ ] Реализовать как синглтон.
    - [ ] Завести `Map<String, Contact>` для хранения контактов (ключ - ник в нижнем регистре).
    - [ ] Использовать `ConcurrentHashMap` или `ReentrantReadWriteLock` для потокобезопасности.

- [ ] **Портировать `Pulse()` и фоновую службу**:
    - [ ] Создать `ContactMonitorService.java` (или использовать `WorkManager`), который будет периодически (например, раз в секунду) вызывать метод `ContactsManager.getInstance().pulse()`.
    - [ ] В методе `pulse()`:
        1.  Найти следующий контакт для проверки (с наименьшим `nextCheck`).
        2.  Использовать `ExecutorService` (аналог `ThreadPool`) для запуска асинхронной задачи `ProcessTask`.
    - [ ] В `ProcessTask`:
        1.  Выполнить сетевой запрос для получения `UserInfo` (портировать `NeverApi.GetAll()`).
        2.  Найти нужный объект `Contact`.
        3.  Вызвать `contact.process(userInfo)`.

- [ ] **Портировать UI-логику**:
    - [ ] Вместо `TreeView` будет использоваться `RecyclerView` с `ExpandableListAdapter` или библиотека для древовидных списков.
    - [ ] Создать `ContactAdapter.java`.
    - [ ] Методы `Add`, `Update`, `Remove` из C#-версии должны будут вызывать соответствующие методы адаптера (`notifyItemInserted`, `notifyItemChanged`, `notifyItemRemoved`).
    - [ ] Логику `GetColorOfContact`, `PrepareContactSign` нужно будет перенести в `onBindViewHolder` адаптера для установки цвета текста и иконок.

- [ ] **Портировать загрузку/сохранение**:
    - [ ] `LoadBossUsers()` и `SaveBossUsers()` нужно будет переписать для работы с `assets` и внутренним хранилищем Android, а также использовать `XmlPullParser` для чтения и `XmlSerializer` для записи `bossusers.xml`.
    - [ ] Основной список контактов, вероятно, будет сохраняться как часть `UserConfig` в JSON.

- [ ] **Обновить `todo_ABClient.md`**, отметив `ContactsManager.cs` как проанализированный.
