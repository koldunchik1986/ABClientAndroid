
### 1. План портирования ch_list.js

Файл `ch_list.js` - это скрипт, отвечающий за отображение списка пользователей в чате.

### 2. Функциональность в C#

- **Назначение:** Динамически сгенерировать HTML-представление списка пользователей в чате на основе данных от сервера.
- **Логика:**
    - **Данные:** Скрипт работает с глобальным JS-массивом `ChatListU`, который содержит строки с данными о пользователях, разделенными двоеточием.
    - **Сортировка:** Включает в себя функции для сортировки списка пользователей по разным критериям (алфавит, уровень).
    - **Рендеринг (`chatlist_build`):** Основная функция, которая перебирает массив пользователей и для каждого генерирует HTML-строку. Эта строка включает имя, клан, склонность, кнопки для личных сообщений и просмотра информации.
    - **Интеграция с C#:** Самая важная часть. Скрипт активно использует `window.external` (JS-мост) для получения дополнительной информации и принятия решений:
        - `GetClassIdOfContact(login)`: Получает от C# "класс" контакта (друг, враг и т.д.) для раскрашивания ника.
        - `CheckFastAttack...()`: Множество вызовов, которые проверяют, нужно ли отображать ту или иную кнопку быстрого действия (нападения, магии) рядом с ником пользователя.

### 3. Решение для портирования на Android

Как и другие подобные скрипты, этот код не портируется. Вместо генерации HTML, необходимо создать нативный список пользователей.

- **UI:** `RecyclerView` для отображения списка пользователей.
- **Данные:** Данные из `ChatListU` должны быть распарсены в `List<ChatUser>`.
- **JS Bridge:** Мост будет использоваться для передачи исходных данных (`ChatListU`) в нативный код, а не для проверок в цикле рендеринга.

### 4. План реализации

1.  **Создать `ChatUser` data-класс:**
    - Будет содержать все поля пользователя (имя, уровень, клан, и т.д.).
2.  **Создать `ChatListParser`:**
    - Класс, который принимает сырую строку `ChatListU` и возвращает `List<ChatUser>`.
3.  **Модифицировать `AndroidBridge`:**
    - Создать метод `@JavascriptInterface fun updateUserList(userListData: String)`, который будет вызываться из JS, когда список пользователей обновляется.
    - Внутри этого метода вызывать `ChatListParser`.
4.  **Создать UI списка:**
    - Создать `Fragment` со `RecyclerView`.
    - Создать `ChatUserAdapter` для `RecyclerView`.
5.  **Реализовать логику адаптера:**
    - В `onBindViewHolder` адаптера, для каждого пользователя:
        - Установить имя, иконки клана и т.д.
        - **Вместо `window.external.Check...`**, адаптер будет напрямую обращаться к `FastActionManager` или `ContactManager` (портированным классам), чтобы решить, какие кнопки действий (`ImageButton`) делать видимыми (`View.VISIBLE`), а какие скрывать (`View.GONE`).

- [ ] Создать data-класс `ChatUser`.
- [ ] Создать `ChatListParser`.
- [ ] Добавить в `AndroidBridge` метод для получения списка пользователей из `WebView`.
- [ ] Создать `Fragment` и `RecyclerView.Adapter` для отображения списка.
- [ ] Реализовать в адаптере логику отображения/скрытия кнопок быстрых действий.
