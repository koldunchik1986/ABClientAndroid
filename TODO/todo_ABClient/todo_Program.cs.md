# План портирования Program.cs

Файл `Program.cs` содержит статический метод `Main()`, который является точкой входа всего C# приложения.

## Функциональность в C#

*   **Назначение**: Выполнить последовательную инициализацию всех основных менеджеров и сервисов приложения, загрузить профиль пользователя и запустить главный UI.
*   **Последовательность инициализации**:
    1.  Настройка окружения (`EnableVisualStyles`, `ServicePointManager`).
    2.  Инициализация `DataManager`.
    3.  **Выбор и загрузка профиля пользователя (`ConfigSelector.Process()`). Это блокирующий шаг.**
    4.  Инициализация глобальных переменных (`AppVars`) и менеджеров (`AppTimerManager`, `ChatUsersManager`) на основе загруженного профиля.
    5.  Выполнение специфичных для Windows действий (`ExplorerHelper.ClearCache`, `FeatureBrowserEmulation.ChangeMode`).
    6.  Запуск локального прокси-сервера.
    7.  Создание и запуск главной формы `FormMain` (`Application.Run`).
*   **Последовательность завершения**:
    1.  После закрытия `FormMain`, вызывается `ChatUsersManager.Save()`.

## Проверка на существующую реализацию в Android

- **Результат:** Частично реализовано.
- **Объяснение**:
    1.  В проекте есть класс `ABClientApplication.java`, который является аналогом `Program.cs` и точкой входа приложения.
    2.  В его методе `onCreate` уже выполняется инициализация `AppVars` и `DataManager`.
    3.  Однако, большинство ключевых шагов инициализации из `Program.Main()` отсутствуют. Логика выбора профиля, запуска прокси и т.д. находится в `LoginActivity` и `MainActivity`, а не в централизованном месте старта приложения.

## Решение для портирования на Android

Необходимо перенести логику инициализации из `Program.Main()` в соответствующие места жизненного цикла Android-приложения, в основном в `ABClientApplication.onCreate()` и `LoginActivity`.

## План реализации

- [ ] **Пересмотреть `ABClientApplication.onCreate()`**:
    - [ ] Сюда следует перенести инициализацию синглтонов, которые не зависят от профиля пользователя.
    - [ ] `ChatUsersManager.load()`: Загрузку кэша пользователей можно выполнять здесь, до выбора профиля.
    - [ ] `startProxyService()`: Запуск прокси-сервиса логично выполнять именно здесь, при старте приложения, а не в `MainActivity`.

- [ ] **Пересмотреть `LoginActivity`**:
    - [ ] Этот `Activity` является прямым аналогом `MyProfile.ConfigSelector.Process()`.
    - [ ] **После** успешной авторизации и получения объекта `UserConfig` (`AppVars.Profile`), здесь необходимо выполнить всю инициализацию, которая зависит от профиля:
        - `AppTimerManager.setAppTimers(...)`
        - `AppVars.AppVersion.addNick(...)`

- [ ] **Пересмотреть `MainActivity` и `Application` для логики завершения**:
    - [ ] Логику `ChatUsersManager.save()` следует вызывать в методе `onTerminate()` класса `ABClientApplication` или в `onDestroy()` главного `Activity`, чтобы гарантировать сохранение данных при закрытии приложения.

- [ ] **Исключить Windows-специфичный код**:
    - [ ] Код, связанный с `ExplorerHelper` и `FeatureBrowserEmulation`, не переносится, так как он уже решен другими средствами.

- [ ] **Обновить `todo_ABClient.md`**, отметив `Program.cs` как проанализированный.
