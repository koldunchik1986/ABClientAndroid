# План портирования UnderAttack.cs

Файл `UnderAttack.cs` - это статический класс, который анализирует страницу боя и анонсирует в чат информацию о нападении.

## Функциональность в C#

*   **Назначение**: Когда начинается бой, этот класс парсит HTML-страницу боя, чтобы определить, кто на кого напал, и отправить информационное сообщение в игровой чат (общий, клановый или парный).
*   **Асинхронная обработка**: Основная логика вынесена в метод `ParseAsync`, который выполняется в фоновом потоке (`ThreadPool`) для предотвращения блокировки UI.
*   **Парсинг**: Логика завязана на парсинге JavaScript-переменных прямо из HTML-кода: `fight_ty` (ID боя), `lives_g1` (участники команды 1) и `lives_g2` (участники команды 2).
*   **Формирование сообщения**: На основе анализа участников и настроек профиля (`AppVars.Profile.LezSay`) генерируется сообщение, например: *"%clan% на меня напал перс «Вася», клетка 1-2-3, [[ID_БОЯ]] (обычное нападение)!"*.
*   **Отправка в чат**: Использует `AppVars.MainForm.BeginInvoke` для безопасной отправки сообщения в UI-поток чата.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность не реализована. В Android-проекте нет аналога этого класса.

## Решение для портирования на Android

Необходимо создать синглтон-класс `UnderAttackHandler.java`. Логику парсинга нужно будет перенести, а отправку сообщений в чат реализовать через `LiveData` или `EventBus`.

## План реализации

- [ ] **Создать файл `UnderAttackHandler.java`** в пакете `ru.neverlands.abclient.manager`.

- [ ] **Реализовать класс как синглтон**.

- [ ] **Портировать метод `parse(String html)`**:
    - [ ] Метод должен принимать HTML-код страницы боя.
    - [ ] Для выполнения парсинга в фоновом потоке следует использовать `ExecutorService` или корутины.
    - [ ] Внутри фоновой задачи перенести логику парсинга `fight_ty`, `lives_g1`, `lives_g2` с помощью `String.indexOf` и `String.substring`.
    - [ ] Перенести логику определения, кто является атакующим, а кто защищающимся.
    - [ ] Перенести логику формирования сообщения.

- [ ] **Реализовать отправку сообщения**:
    - [ ] Вместо прямого вызова `MainForm`, `UnderAttackHandler` должен отправлять событие с готовым сообщением (например, через `LiveData` в `ViewModel` или через `EventBus`).
    - [ ] `MainActivity` будет подписана на это событие и, получив его, отобразит сообщение в соответствующем `WebView` чата.

- [ ] **Интеграция**:
    - [ ] В `PostFilter`-классе, который обрабатывает страницу боя (`fight.php`), нужно будет вызывать `UnderAttackHandler.getInstance().parse(html)`.

- [ ] **Обновить `todo_ABClient.md`**, отметив `UnderAttack.cs` как проанализированный.
