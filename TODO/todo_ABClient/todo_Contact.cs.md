# План портирования Contact.cs

Файл `Contact.cs` определяет сложный класс, который не только хранит данные о контакте, но и содержит всю логику для активного мониторинга его состояния.

## Функциональность в C#

*   **Назначение**: Представляет собой "живой" объект контакта, который периодически обновляет свои данные, сравнивает их с предыдущим состоянием и генерирует новостные сообщения в чат о любых изменениях.
*   **Свойства**: Хранит как статическую информацию (имя, группа, комментарии), так и динамическую (уровень, локация, онлайн-статус, одетые вещи, травмы, эффекты, лог боя).
*   **Основная логика (`Process(UserInfo userInfo)`)**: Это сердце класса. При каждом вызове он:
    1.  Получает свежий объект `UserInfo`.
    2.  Сравнивает новое состояние со старым по десяткам параметров.
    3.  Обнаруживает события: вход/выход, смена локации, смена одежды, получение травмы, получение/потеря эффекта, начало нового боя.
    4.  Для каждого события генерирует HTML-форматированное сообщение.
    5.  Если были события, отправляет одно большое сообщение в чат и обновляет UI контакта.
    6.  Обновляет свое внутреннее состояние.
    7.  Планирует время следующей проверки (`NextCheck`).
*   **Вспомогательные методы**: Содержит методы для генерации HTML-кода для ников и информации о персонажах.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность не реализована. В коде есть упоминание `GetClassIdOfContact`, что говорит о планах на `ContactsManager`, но сам класс `Contact` и его сложная логика мониторинга отсутствуют.

## Решение для портирования на Android

Портирование этого класса — крупная задача. Необходимо создать класс-модель `Contact.java` и, что более важно, создать сервис или фоновую задачу, которая будет периодически получать `UserInfo` для каждого отслеживаемого контакта и вызывать его метод `process()`.

## План реализации

- [ ] **Создать файл `Contact.java`** в пакете `ru.neverlands.abclient.model`.
    - [ ] Перенести все поля из C#-класса, адаптировав типы (`DateTime` -> `long`, `string[]` -> `List<String>`, `int[]` -> `int[]`).
    - [ ] Создать конструкторы.

- [ ] **Портировать метод `process(UserInfo userInfo)`**:
    - [ ] Это будет основной и самый сложный метод. Всю логику сравнения `if (!_isFirst && ...)` нужно будет аккуратно перенести.
    - [ ] Потребуется портировать `UserInfo`.
    - [ ] Сетевые запросы (`wc.DownloadData`) внутри `process` - плохая практика для Android. Эту часть нужно вынести во внешний сервис, который будет сначала загружать данные, а потом передавать их в `process`.
    - [ ] Генерацию HTML-сообщений можно оставить, так как они будут отображаться в `WebView`.

- [ ] **Портировать вспомогательные методы**:
    - [ ] `HtmlPercEntry(String nick)` и `HtmlContactEntry(Contact contact)`.
    - [ ] Потребуется портировать `NeverApi.GetAll()` и `ContactsManager.GetClassIdOfContact()`.

- [ ] **Создать `ContactsManager.java`**:
    - [ ] Этот менеджер будет хранить `List<Contact>`.
    - [ ] Он должен будет содержать фоновую службу (например, через `WorkManager` или `Coroutine`), которая:
        1.  Периодически проходит по списку отслеживаемых контактов (`Tracing == true`).
        2.  Проверяет, настало ли время `NextCheck`.
        3.  Если да, асинхронно загружает `UserInfo` для этого контакта.
        4.  Вызывает метод `contact.process(userInfo)`.
        5.  Собирает сгенерированные сообщения и отправляет их в UI (через `LiveData` или `EventBus`).

- [ ] **Обновить `todo_ABClient.md`**, отметив `Contact.cs` как проанализированный.
