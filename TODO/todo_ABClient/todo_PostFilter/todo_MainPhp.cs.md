# План портирования MainPhp.cs

Файл `MainPhp.cs` (и его `partial` части) является центральным компонентом, "мозгом" всей автоматизации клиента.

## Функциональность в C#

*   **Назначение**: Обрабатывать основную игровую страницу `main.php`, анализировать ее текущее состояние и на основе этого запускать различные автоматические действия (авто-бой, авто-рыбалка, авто-лечение и т.д.).
*   **Реализация**: Представляет собой огромный метод `MainPhp` с длинной последовательностью `if`-проверок. Каждая проверка отвечает за определенный аспект игры:
    1.  **Сбор информации**: Парсит HTML для получения информации о местоположении, системных сообщениях, результатах воровства, травмах и ядах, списке комплектов.
    2.  **Запуск действий**: На основе полученной информации и настроек профиля, инициирует действия. Например, если `AppVars.Profile.FishAuto` включен и на странице есть кнопка рыбалки, он генерирует HTML с редиректом на URL этой кнопки.
    3.  **Управление состоянием**: Управляет множеством глобальных флагов в `AppVars` для координации действий между различными фильтрами и частями приложения.

## Проверка на существующую реализацию в Android

- **Результат:** Реализована только самая базовая "заглушка".
- **Объяснение**:
    1.  В проекте существует класс `app/src/main/java/ru/neverlands/abclient/postfilter/MainPhp.java`.
    2.  Он содержит только метод `filterGetLocation` (причем не до конца реализованный) и пустой метод `process`, который ничего не делает, кроме удаления `DOCTYPE`.
    3.  Вся сложная логика отсутствует, что подтверждается комментариями `TODO`.

## Решение для портирования на Android

Это самая большая и сложная задача портирования. Необходимо аккуратно перенести всю логику, разбив ее на более мелкие и управляемые методы. Вместо `goto end;` следует использовать `return` из методов.

## План реализации

- [ ] **Открыть `MainPhp.java`**.

- [ ] **Создать отдельные приватные методы** для каждого логического блока из C#-версии:
    - [ ] `private static byte[] handleSystemMessages(String html)`: Перенести логику парсинга системных сообщений.
    - [ ] `private static byte[] handleAutoCure(String html, String address)`: Перенести логику авто-лечения.
    - [ ] `private static byte[] handleAutoFish(String html, String address)`: Перенести логику авто-рыбалки.
    - [ ] `private static byte[] handleAutoSkin(String html, String address)`: Перенести логику авто-разделки.
    - [ ] `private static byte[] handleAutoNavigate(String html, String address)`: Перенести логику авто-навигации.
    - [ ] `private static byte[] handleFastActions(String html, String address)`: Перенести логику быстрых действий.
    - [ ] ... и так далее для всех остальных блоков (`Rob`, `Drink`, `Wear`, `Inv`, `Fight`).

- [ ] **Изменить основной метод `process`**, чтобы он стал конвейером (pipeline):
    ```java
    public static byte[] process(String address, byte[] array) {
        // ... начальная инициализация ...
        String html = Russian.getString(array);

        html = handleSystemMessages(html);
        html = handleAutoActions(html, address); // Этот метод будет вызывать другие по цепочке
        // ... и т.д.

        return Russian.getBytes(html);
    }
    ```
    *Каждый метод-обработчик будет принимать `html` и возвращать его (возможно, измененный). Это позволит избежать использования `goto`.*

- [ ] **Портировать все зависимости**: Для реализации этих методов потребуется сначала портировать множество других классов, от которых они зависят (`Map`, `MapPath`, `TorgList`, `Chat`, `NeverApi` и т.д.).

- [ ] **Обновить `todo_PostFilter.md`**, отметив `MainPhp.cs` и все его `partial`-части как проанализированные.
