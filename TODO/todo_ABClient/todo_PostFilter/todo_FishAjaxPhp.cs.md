# План портирования FishAjaxPhp.cs

Файл `FishAjaxPhp.cs` - это сложный фильтр для обработки AJAX-ответов от сервера во время рыбалки.

## Функциональность в C#

*   **Назначение**: Перехватить и полностью переформатировать ответ сервера после заброса удочки. Вместо короткого серверного ответа, он генерирует подробный HTML-отчет со статистикой и экономикой.
*   **Логика**:
    1.  Проверяет ответ на наличие ошибок (нет снастей, нет приманки) и останавливает авто-рыбалку, если они найдены.
    2.  Парсит строку ответа, извлекая название рыбы, улов и информацию о повышении умения.
    3.  Используя жестко закодированные таблицы цен, вычисляет доход/убыток от улова.
    4.  Обновляет глобальные переменные статистики (`AppVars.Profile.FishUm`, `AppVars.AutoFishNV`).
    5.  Генерирует подробный HTML-отчет для `WebView`.
    6.  Генерирует краткий текстовый отчет для системного трея.
    7.  Генерирует отчет для игрового чата.
    8.  Асинхронно обновляет все части UI (`MainForm`) с новой информацией.

## Проверка на существующую реализацию в Android

- **Результат:** Частично реализовано.
- **Объяснение**:
    1.  В проекте существует класс `app/src/main/java/ru/neverlands/abclient/postfilter/FishAjaxPhp.java`.
    2.  В нем реализована основная логика: проверка на ошибки, парсинг ответа, расчет экономики и генерация основного HTML-отчета.
    3.  **Отсутствует** вся логика взаимодействия с UI. Все вызовы `BeginInvoke` для обновления трея, чата и других элементов заменены на комментарии `// TODO`.
    4.  Отсутствует генерация отчетов для трея и чата.

## Решение для портирования на Android

Необходимо завершить портирование, добавив недостающую логику обратной связи с пользователем.

## План реализации

- [ ] **Открыть `FishAjaxPhp.java`**.

- [ ] **Реализовать систему событий**: Вместо прямого вызова UI, `FishAjaxPhp` должен отправлять события. `LocalBroadcastManager` - хороший кандидат.
    - [ ] В блоке проверки ошибок отправлять `new Intent("ACTION_STOP_FISHING")`.
    - [ ] После расчета экономики отправлять `new Intent("ACTION_UPDATE_FISH_NV").putExtra("nv_change", (int)bal)`.
    - [ ] Реализовать генерацию текстовых отчетов для трея и чата.
    - [ ] Для трея: создавать `Notification` с помощью `NotificationManagerCompat`.
    - [ ] Для чата: отправлять `new Intent("ACTION_SEND_CHAT_MESSAGE").putExtra("message", ...)`.

- [ ] **Подписать `MainActivity` на события**:
    - [ ] Создать `BroadcastReceiver` в `MainActivity`.
    - [ ] В `onResume` подписываться на все новые `ACTION_...`, а в `onPause` отписываться.
    - [ ] В `onReceive` обработчика вызывать соответствующие методы для обновления UI (обновить текстовое поле с доходом, отправить сообщение в `WebView` чата и т.д.).

- [ ] **Обновить `todo_PostFilter.md`**, отметив `FishAjaxPhp.cs` как проанализированный.
