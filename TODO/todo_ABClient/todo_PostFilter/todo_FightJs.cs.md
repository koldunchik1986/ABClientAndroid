
### 1. План портирования FightJs.cs

Файл `FightJs.cs` является одним из самых важных и сложных фильтров. Он модифицирует JavaScript-код боя (`fight_v*.js`), внедряя в него интерфейс и логику для работы автобоя.

### 2. Функциональность в C#

- **Назначение:** Полностью изменить панель управления боем, добавив кнопки для автобоя и связав их с логикой C#-клиента через `window.external`.
- **Логика:** Выполняет серию сложных замен в JS-коде:
    1.  **Внедрение кнопок:** Находит стандартные кнопки "Ход" и "Сбросить" и заменяет их на целый новый блок, включающий:
        - `ход (0:00)`: Модифицированная кнопка хода с таймером.
        - `автовыбор`: Кнопка, которая вызывает `window.external.AutoSelect()`. Этот метод в C# запускает движок `LezFight` для расчета хода, но *не отправляет* его, а только показывает выбранные приемы в UI боя (выставляет `selectedIndex` у `select`'ов).
        - `автоход`: Кнопка, вызывающая `window.external.AutoTurn()`. Этот метод рассчитывает ход и **сразу же отправляет его**, вызывая JS-функцию `AutoSubmit`.
        - `автобой`: Кнопка, вызывающая `window.external.AutoBoi()`, которая переключает флаг полного автобоя.
    2.  **Внедрение JavaScript:** Вместе с кнопками внедряется большой блок JS-кода:
        - `myStartAct()`: Обёртка над стандартной функцией `StartAct()`, которая сначала уведомляет C#-код о начале хода (`ResetLastBoiTimer`).
        - `xodtimerproc()`: Таймер, который раз в секунду вызывает `window.external.XodButtonElapsedTime()` для получения и отображения времени раунда.
        - `AutoSubmit(result)`: **Ключевая функция обратного вызова.** C#-код, рассчитав ход, вызывает эту JS-функцию, передавая ей строку с параметрами хода. JS-код парсит эту строку, динамически создает и заполняет скрытую форму и отправляет ее на сервер.
        - `AutoSelect()`, `AutoTurn()`, `AutoBoi()`, `ResetCure()`: Простые функции-обертки для вызова соответствующих методов в `window.external`.
    3.  **Перехват других событий:** Модифицирует кнопку "Завершить" в конце боя, чтобы она также вызывала `window.external.ResetCure()`.

### 3. Решение для портирования на Android

Необходимо в точности воспроизвести все модификации JS-кода, заменив `window.external` на `AndroidBridge`. Это потребует значительного расширения `WebAppInterface` и создания `FightViewModel` для инкапсуляции сложной логики боя.

- **Архитектура:**
    - `FightJs.java`: Выполнит все замены строк.
    - `WebAppInterface.java`: Будет содержать все методы, вызываемые из JS (`AutoSelect`, `AutoTurn`, `XodButtonElapsedTime` и т.д.).
    - `FightViewModel.kt`: Будет содержать состояние автобоя (`isAutoBattleActive`) и управлять взаимодействием между `FightDecisionEngine` (портированный `LezFight`) и `WebView`.

### 4. План реализации

1.  **Реализовать `FightJs.java`:**
    - [x] В методе `process(byte[] array)` преобразовать массив в строку.
    - [x] Аккуратно, соблюдая экранирование, перенести все вызовы `sb.Replace(...)` из C# в `html.replace(...)` в Java.
    - [x] Заменить все `window.external.` на `AndroidBridge.`.
    - [x] Вернуть измененный JS-код в виде `byte[]`.
2.  **Расширить `WebAppInterface.java`:**
    - [x] Добавить все новые методы, вызываемые из JS, с аннотацией `@JavascriptInterface`:
        - `AutoSelect()`
        - `AutoTurn()`
        - `AutoBoi()`
        - `ResetCure()`
        - `ResetLastBoiTimer()`
        - `XodButtonElapsedTime(): String`
    - [x] Внутри этих методов пока можно разместить заглушки с логированием (`Log.d(...)`).
3.  **Создать `FightViewModel.kt`:**
    - [ ] Создать `ViewModel` для логики боя. Он будет получать `Bitmap` боя, передавать его в `FightDecisionEngine` (который будет портирован позже) и получать обратно объект с решением.
    - [ ] `AutoSelect()` в `WebAppInterface` будет вызывать метод в `ViewModel`, который рассчитает ход и вернет JS-код для обновления `select`'ов в `WebView`.
    - [ ] `AutoTurn()` в `WebAppInterface` будет вызывать метод в `ViewModel`, который вернет готовую строку для передачи в JS-функцию `AutoSubmit`.
4.  **Обновить `todo_PostFilter.md`:**
    - [x] Пометить `FightJs.cs` как `[x]` проанализированный.

- [x] Реализовать `FightJs.java` со всеми заменами строк.
- [x] Добавить все необходимые методы-заглушки в `WebAppInterface.java`.
- [ ] Создать `FightViewModel.kt` (пока можно пустой).
