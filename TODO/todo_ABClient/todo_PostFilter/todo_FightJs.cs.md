# План портирования FightJs.cs

Файл `FightJs.cs` - это очень сложный и важный фильтр, который внедряет основной функционал автобоя в страницу боя.

## Функциональность в C#

*   **Назначение**: Полностью изменить панель управления боем, добавив кнопки для автоматизации действий и связав их с нативной C#-логикой.
*   **Логика**: 
    1.  **Замена кнопок**: Находит стандартные кнопки "ход" и "сбросить" и заменяет их на расширенную панель с кнопками "ход (с таймером)", "автовыбор", "автоход", "автобой".
    2.  **Внедрение JS-моста**: Добавляет на страницу большой блок JavaScript. Этот блок создает функции-обертки (`AutoSelect`, `AutoTurn`, `AutoBoi` и т.д.), которые просто вызывают соответствующие методы на `window.external` (то есть, в `ScriptManager.cs`).
    3.  **Таймер хода**: Внедренный JS-код запускает таймер, который каждую секунду вызывает `window.external.XodButtonElapsedTime()` для обновления времени на кнопке "ход".
    4.  **Перехват других кнопок**: Модифицирует кнопку "Завершить", чтобы перед отправкой формы она вызывала нативный метод `ResetCure()`.
    5.  **Внедрение `AutoSubmit`**: Добавляет на страницу JS-функцию `AutoSubmit`, которую C#-код может вызвать для программной отправки формы боя с нужными параметрами.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность не реализована. В `Filter.java` вызов этого фильтра закомментирован.

## Решение для портирования на Android

Это одна из самых важных частей для портирования. Необходимо в точности воспроизвести всю логику замены HTML и внедрения JavaScript. Потребуется предварительно портировать `ScriptManager`, чтобы было что вызывать из нового JS-кода.

## План реализации

- [ ] **Предварительный шаг: Портировать `ScriptManager.cs`**:
    - [ ] Реализовать `ScriptManager.java` и зарегистрировать его в `WebView` под именем `AndroidBridge`.
    - [ ] В `ScriptManager.java` создать все методы-заглушки (`AutoSelect`, `AutoTurn`, `AutoBoi`, `XodButtonElapsedTime` и т.д.).

- [ ] **Создать файл `FightJs.java`** в пакете `ru.neverlands.abclient.postfilter`.

- [ ] **Портировать метод `process(byte[] array)`**:
    - [ ] Перенести всю логику замен из C#-метода `FightJs`.
    - [ ] Все вызовы `window.external` нужно будет заменить на `AndroidBridge`.
    - [ ] Убедиться, что все строки, особенно многострочный JavaScript-код, корректно экранированы и перенесены.

- [ ] **Реализовать методы в `ScriptManager.java`**:
    - [ ] Наполнить реальной логикой методы-заглушки, созданные на первом шаге. Например, `AutoBoi()` должен будет вызывать соответствующий метод в `MainActivity` или в новом `AutoboiManager`.

- [ ] **Раскомментировать вызов в `Filter.java`**, чтобы фильтр начал применяться.

- [ ] **Обновить `todo_PostFilter.md`**, отметив `FightJs.cs` как проанализированный.