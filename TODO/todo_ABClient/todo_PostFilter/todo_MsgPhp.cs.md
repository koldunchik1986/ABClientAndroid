# План портирования MsgPhp.cs

Файл `MsgPhp.cs` - это часть `partial` класса `Filter`, отвечающая за обработку фрейма с сообщениями чата.

## Функциональность в C#

*   **Назначение**: Сохранять историю чата между перезагрузками фрейма.
*   **Логика**: Если в профиле пользователя включена опция `ChatKeepGame`, фильтр берет содержимое глобальной переменной `AppVars.Chat` (где, предположительно, накапливается история) и вставляет его в начало `div`-элемента с `id=msg`.

## Проверка на существующую реализацию в Android

- **Результат:** Не реализовано. Существующий файл `MsgPhp.java` выполняет совершенно другую задачу.
- **Объяснение**:
    1.  В проекте существует класс `app/src/main/java/ru/neverlands/abclient/postfilter/MsgPhp.java`.
    2.  Однако, его метод `process()` не реализует логику сохранения истории чата.
    3.  Вместо этого, он выполняет большое количество замен, перехватывая все JavaScript-функции `show_info(...)`, `show_clan_info(...)` и т.д. и перенаправляя их на `window.external` (будущий `AndroidBridge`). Эта логика, вероятно, была взята из другого C#-фильтра и консолидирована здесь.

## Решение для портирования на Android

Необходимо добавить недостающую логику сохранения истории чата в существующий `MsgPhp.java`.

## План реализации

- [ ] **Открыть `MsgPhp.java`**.

- [ ] **Добавить логику сохранения истории** в метод `process(byte[] array)`:
    ```java
    // В начало метода process, после получения html из array
    if (AppVars.Profile != null && AppVars.Profile.ChatKeepGame && AppVars.Chat != null && !AppVars.Chat.isEmpty()) {
        html = html.replace(" id=msg>", " id=msg>" + AppVars.Chat);
    }
    ```

- [ ] **Реализовать накопление истории в `AppVars.Chat`**:
    - [ ] Необходимо найти место, где в C#-коде обновлялась переменная `AppVars.Chat`, и портировать эту логику. Вероятно, это происходило в `ChMsgJs.cs` при обработке новых сообщений.

- [ ] **Обновить `todo_PostFilter.md`**, отметив `MsgPhp.cs` как проанализированный.
