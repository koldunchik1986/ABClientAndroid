
### 1. План портирования MainPhpFight.cs

Файл `MainPhpFight.cs` содержит основную логику для функции автоматического боя ("автобой"). Это не фильтр, а сложный конечный автомат, который управляет всем процессом боя.

### 2. Функциональность в C#

- **Назначение:** Автоматически вести бой от лица игрока.
- **Логика:**
    1.  **Парсинг состояния боя:** Использует класс `LezFight` для полного разбора HTML-кода страницы боя. `LezFight` извлекает всю информацию: кто ходит, какие удары/блоки доступны, уровни HP/MA, активные эффекты и т.д.
    2.  **Проверка на валидность:** Убеждается, что HTML-код боя не поврежден.
    3.  **Ожидание хода:** Если сейчас ход противника, может инициировать обновление страницы.
    4.  **Логика автобоя:** Если автобой включен (`AppVars.Profile.LezDoAutoboi`):
        *   **Во время боя:**
            *   Проверяет условия для остановки: низкий уровень HP/MA, опасный противник, ручная команда на выход.
            *   Если условий для остановки нет, `LezFight` определяет наилучшее следующее действие (удар, блок) и модифицирует HTML-фрейм, чтобы выполнить это действие. Модифицированный фрейм возвращается браузеру.
            *   Если условия для остановки выполнены, автобой прекращается, в чат отправляется сообщение, и в некоторых случаях клиент может быть закрыт.
        *   **После боя:**
            *   Определяет, нужно ли лечение после боя.
            *   Может перейти в состояние `Restoring` для ожидания восстановления HP/MA.
            *   После восстановления может вернуть игрока на локацию, где он был до боя (`AppVars.FightLink`).

### 3. Решение для портирования на Android

Это ядро боевого движка бота. Логика чрезвычайно сложна и глубоко интегрирована с состоянием C# приложения (`AppVars`, `LezFight`, `AutoboiState`). Она должна быть полностью спроектирована и реализована заново в Android-приложении.

### 4. План реализации

1.  **Создать класс `FightEngine` в Android:**
    - Этот класс будет управлять состоянием боя и принятием решений.
2.  **Создать класс `FightStateParser`:**
    - Аналог `LezFight`. Будет отвечать за полный парсинг HTML-кода боя и предоставление `FightEngine` структурированной информации о состоянии боя.
3.  **Создать классы для стратегий (`FightStrategy`):**
    - Реализовать различные стратегии ведения боя (атакующая, защитная, против определенных классов), которые `FightEngine` сможет использовать.
4.  **Интеграция с `WebViewClient`:**
    - `WebViewClient` будет перехватывать все ответы от `main.php`, содержащие бой.
    - HTML-код будет передаваться в `FightStateParser`.
    - `FightEngine` будет получать объект состояния боя, выбирать стратегию и определять следующее действие.
    - `FightEngine` будет генерировать и выполнять следующий `POST`-запрос для выполнения этого действия.
5.  **Управление состоянием вне боя:**
    - Реализовать логику лечения и возвращения на предыдущую локацию после боя.

- [ ] Создать класс `FightEngine`.
- [ ] Создать класс `FightStateParser`.
- [ ] Разработать интерфейс `FightStrategy` и несколько его реализаций.
- [ ] Интегрировать движок с `WebViewClient`.
- [ ] Реализовать логику послебоевого восстановления.
