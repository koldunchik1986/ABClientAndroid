
### 1. План портирования ChMsgJs.cs

Файл `ChMsgJs.cs` является фильтром для скрипта `ch_msg_v01.js`, который отвечает за рендеринг сообщений в окне чата.

### 2. Функциональность в C#

- **Назначение:** Внедрить в скрипт чата "хуки" (hooks) для интеграции с нативным клиентом.
- **Логика:** Выполняет серию замен в тексте JS-файла:
    1.  **Перехват сообщений:** Заменяет `s += txt + "<BR>"` на `s += window.external.ChatFilter(txt) + "<BR>"`. Это самая важная часть: каждое сообщение `txt` перед отображением отправляется в C#-код (метод `ChatFilter`), где оно может быть проанализировано или изменено.
    2.  **Уведомление об обновлении:** Добавляет вызов `window.external.ChatUpdated()` после обновления чата. Это сигнализирует хосту, что чат обновился.
    3.  **Улучшение приватных сообщений:** Внедряет сложный блок JS-кода, который изменяет поведение клика по нику в чате. Новый код позволяет умнее формировать приватные сообщения: если в строке ввода уже есть префикс `%clan%` или `%pair%`, то ник просто добавляется, в противном случае — создается новое приватное сообщение.
    4.  **Мелкие исправления:** Заменяет `alt=` на `title=` для корректных всплывающих подсказок и удаляет части кода, связанные с `scrollLeft`/`scrollTop`, для исправления позиционирования элементов.

### 3. Решение для портирования на Android

Необходимо воспроизвести все строковые замены, заменив вызовы `window.external` на вызовы к единому `JavascriptInterface` (например, `AndroidBridge`).

- **Архитектура:**
    - Логика замен останется в `postfilter.ChMsgJs.java`.
    - В `WebAppInterface` будут добавлены соответствующие методы (`chatFilter`, `chatUpdated`).
    - Логика, которая в C# находилась внутри `ChatFilter` (анализ боев, системных сообщений), будет перенесена в `ChatViewModel` или `ChatRepository`, который будет получать сообщения от `WebAppInterface`.

### 4. План реализации

1.  **Реализовать `ChMsgJs.java`:**
    - [ ] В методе `process(byte[] array)` преобразовать массив в строку.
    - [ ] Выполнить замену для `ChatFilter`:
        - `find: s += txt + "<BR>"`
        - `replace: s += AndroidBridge.chatFilter(txt) + "<BR>"`
    - [ ] Выполнить замену для `ChatUpdated`:
        - `find: ,65000);`
        - `replace: , 65000); AndroidBridge.chatUpdated()`
    - [ ] Перенести и адаптировать сложный JS-код для обработки кликов по никам.
    - [ ] Выполнить остальные мелкие замены (`alt=` -> `title=`, и т.д.).
    - [ ] Вернуть измененный JS-код в виде `byte[]`.
2.  **Обновить `WebAppInterface.java`:**
    - [ ] Добавить метод `@JavascriptInterface public String chatFilter(String message)`.
        - Внутри метода, для начала, можно просто логировать сообщение и возвращать его без изменений: `Log.d("ChatFilter", message); return message;`.
    - [ ] Добавить метод `@JavascriptInterface public void chatUpdated()`.
        - Внутри можно оставить заглушку.
3.  **Обновить `todo_PostFilter.md`:**
    - [ ] Пометить `ChMsgJs.cs` как `[x]` проанализированный.

- [ ] Реализовать `ChMsgJs.java` со всеми заменами строк.
- [ ] Добавить методы `chatFilter` и `chatUpdated` в `WebAppInterface.java`.
