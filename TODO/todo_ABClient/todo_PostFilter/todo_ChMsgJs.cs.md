# План портирования ChMsgJs.cs

Файл `ChMsgJs.cs` - это часть `partial` класса `Filter`, отвечающая за сложную модификацию скрипта чата `ch_msg.js`.

## Функциональность в C#

*   **Назначение**: Перехватывать и изменять ключевые функции в `ch_msg.js` для интеграции с нативным клиентом.
*   **Логика**: Выполняет множество замен в коде JavaScript:
    1.  **Фильтрация сообщений**: Оборачивает добавление нового сообщения в вызов `window.external.ChatFilter`, позволяя C#-коду фильтровать каждое сообщение.
    2.  **Уведомление об обновлении**: Добавляет вызов `window.external.ChatUpdated` после обновления чата.
    3.  **Обработка ников**: Содержит сложную логику для изменения поведения при клике на ник, добавляя префиксы для клан-чата и парного чата (`%clan%`, `%pair%`).
    4.  **Другие исправления**: Заменяет `alt=` на `title=`, удаляет код, связанный с прокруткой.

## Проверка на существующую реализацию в Android

- **Результат:** Частично реализовано.
- **Объяснение**:
    1.  В проекте существует класс `app/src/main/java/ru/neverlands/abclient/postfilter/ChMsgJs.java`.
    2.  Большинство замен из C#-версии уже перенесены и адаптированы под `AndroidBridge`.
    3.  Однако, несколько сложных замен, связанных с `msgp[2]`, закомментированы с пометкой `TODO: Исправить и раскомментировать проблемные замены`.

## Решение для портирования на Android

Необходимо завершить портирование, исправив и раскомментировав проблемные участки кода в `ChMsgJs.java`.

## План реализации

- [ ] **Открыть `ChMsgJs.java`**.

- [ ] **Проанализировать закомментированную логику**:
    - [ ] Внимательно изучить две закомментированные замены, которые манипулируют `msgp[2]`.
    - [ ] Понять, почему они были сочтены "проблемными". Вероятно, из-за сложности с экранированием кавычек и синтаксисом в Java.

- [ ] **Исправить и реализовать замены**:
    - [ ] Аккуратно перенести логику, возможно, разбив сложные строки на несколько частей для лучшей читаемости.
    - [ ] Раскомментировать код и убедиться, что он корректно встраивается в остальной скрипт.

- [ ] **Обновить `todo_PostFilter.md`**, отметив `ChMsgJs.cs` как проанализированный.