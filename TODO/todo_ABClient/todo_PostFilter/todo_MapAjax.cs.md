# План портирования MapAjax.cs

Файл `MapAjax.cs` - это критически важный фильтр, реализующий "движок" автоматической навигации по карте.

## Функциональность в C#

*   **Назначение**: Перехватывать AJAX-ответ от карты (`map_ajax.php`), парсить из него текущее положение игрока и доступные для перехода клетки, а затем, если включен режим авто-навигации, внедрять в ответ JavaScript-код для совершения следующего шага по маршруту.
*   **Логика**:
    1.  **Парсинг данных**: Извлекает из JS-переменной `var map = [...]` текущие координаты X/Y и список доступных для перемещения соседних клеток с их "магическими кодами".
    2.  **Обновление состояния**: Обновляет глобальную переменную `AppVars.Profile.MapLocation` с текущим местоположением.
    3.  **Логика авто-навигации**: Если `AppVars.AutoMoving` == `true`:
        a. Проверяет, не достигнута ли конечная цель.
        b. Если нет, обращается к объекту `AppVars.AutoMovingMapPath` (который является результатом работы A* алгоритма из `MapPath.cs`) за следующим шагом (`NextJump`).
        c. Находит "магический код" для этого шага в списке доступных ходов, полученном на шаге 1.
        d. Внедряет в HTML-ответ вызов JS-функции `moveMapTo(...)` с параметрами для следующего шага.
    4.  **Обработка телепортов и городов**: Содержит специальную логику для случаев, когда следующий шаг - это телепорт или вход в город.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность не реализована.

## Решение для портирования на Android

Это одна из самых сложных и важных частей для портирования. Ее реализация тесно связана с портированием классов `Map` и `MapPath` из папки `ExtMap`.

## План реализации

- [ ] **Предварительный шаг: Портировать `ExtMap`**:
    - [ ] Необходимо сначала полностью портировать классы `Map.cs` (со всеми ячейками карты) и `MapPath.cs` (алгоритм поиска пути A*).

- [ ] **Создать файл `MapAjax.java`** в пакете `ru.neverlands.abclient.postfilter`.

- [ ] **Портировать метод `process(String html)`** (в Java-версии фильтров он обычно принимает `byte[]`, но для удобства можно работать со строкой):
    - [ ] Перенести логику парсинга JS-переменной `var map` для получения текущей локации и доступных ходов.
    - [ ] Адаптировать обновление глобального состояния `AppVars`.
    - [ ] Перенести всю логику авто-навигации:
        - Проверка достижения цели.
        - Получение следующего шага из портированного `MapPath`.
        - Поиск нужного хода в списке доступных.
        - Генерация и внедрение вызова `moveMapTo(...)` в HTML.

- [ ] **Интегрировать в `Filter.java`**:
    - [ ] Добавить в `Filter.java` правило для перехвата `map_ajax.php` и вызова `MapAjax.process()`.

- [ ] **Обновить `todo_PostFilter.md`**, отметив `MapAjax.cs` как проанализированный.
