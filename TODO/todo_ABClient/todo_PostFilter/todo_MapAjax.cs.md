### 1. План портирования MapAjax.cs

Файл `MapAjax.cs` является частью `partial class` `Filter`. Он обрабатывает AJAX-ответ, содержащий данные игровой карты (`map_ajax.php`), и является ядром системы авто-навигации.

### 2. Зависимости

- **`ExtMap.Map.cs` и `ExtMap.MapPath.cs`:** Как и `TeleportAjax`, этот фильтр полностью зависит от системы навигации для получения информации о клетках и построения маршрутов.

1.  **Парсинг данных**: Извлекает из JS-переменной `var map = [...]` текущие координаты X/Y и список доступных для             │
 │       перемещения соседних клеток с их "магическими кодами".                                                                               │
 │    10 -     2.  **Обновление состояния**: Обновляет глобальную переменную `AppVars.Profile.MapLocation` с текущим местоположением.         │
 │    11 -     3.  **Логика авто-навигации**: Если `AppVars.AutoMoving` == `true`:                                                            │
 │    12 -         a. Проверяет, не достигнута ли конечная цель.                                                                              │
 │    13 -         b. Если нет, обращается к объекту `AppVars.AutoMovingMapPath` (который является результатом работы A* алгоритма из         │
 │       `MapPath.cs`) за следующим шагом (`NextJump`).                                                                                       │
 │    14 -         c. Находит "магический код" для этого шага в списке доступных ходов, полученном на шаге 1.                                 │
 │    15 -         d. Внедряет в HTML-ответ вызов JS-функции `moveMapTo(...)` с параметрами для следующего шага.                              │
 │    16 -     4.  **Обработка телепортов и городов**: Содержит специальную логику для случаев, когда следующий шаг - это телепорт или вход   │
 │       в город.                                                                                                                             │
 │     7 + - **`ExtMap.Map.cs` и `ExtMap.MapPath.cs`:** Как и `TeleportAjax`, этот фильтр полностью зависит от системы навигации для          │
 │       получения информации о клетках и построения маршрутов.                                                                               │
 │     8                                                                                                                                      │
 │    ══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════  │
 │    18 - ## Проверка на существующую реализацию в Android                                                                                   │
 │     9 + ### 3. Функциональность в C#                                                                                                       │
 │    10                                                                                                                                      │
 │    ══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════  │
 │    20 - - **Результат:** Функциональность не реализована.                                                                                  │
 │    11 + - **Назначение:** Управлять автоматическим перемещением игрока по карте.                                                           │
 │    12 + - **Триггер:** Наличие в ответе строки `var map = [[`.                                                                             │
 │    13 + - **Логика:**                                                                                                                      │
 │    14 +     1.  **Парсинг текущей локации:** Извлекает из JS-массива `map` координаты `ourX`, `ourY` и обновляет                           │
 │       `AppVars.Profile.MapLocation`.                                                                                                       │
 │    15 +     2.  **Парсинг доступных ходов:** Далее из того же массива извлекается список соседних клеток, на которые можно перейти,        │
 │       вместе с их `vcode` (магический ключ для перемещения). Этот список сохраняется в `Map.MovableCells`.                                 │
 │    16 +     3.  **Логика авто-навигации:** Если включен флаг `AppVars.AutoMoving`:                                                         │
 │    17 +         - **Проверка достижения цели:** Сравнивает текущую локацию с `AppVars.AutoMovingDestinaton`. Если они совпадают,           │
 │       выключает навигатор.                                                                                                                 │
 │    18 +         - **Расчет/проверка пути:** Убеждается в наличии валидного маршрута в `AppVars.AutoMovingMapPath`. Если его нет, строит    │
 │       новый.                                                                                                                               │
 │    19 +         - **Определение следующего шага:** Получает из `MapPath` следующий шаг (`NextJump`) и его тип (`IsNextTeleport`,           │
 │       `IsNextCity`).                                                                                                                       │
 │    20 +         - **Обработка особых шагов:** Если следующий шаг — это телепорт или городские ворота, фильтр находит на странице кнопку    │
 │       "Войти" и генерирует HTML-редирект для входа в интерфейс телепорта/города.                                                           │
 │    21 +         - **Обработка обычного шага:** Если следующий шаг — это обычное перемещение на соседнюю клетку, фильтр:                    │
 │    22 +             1. Находит координаты `NextJump`.                                                                                      │
 │    23 +             2. **Внедряет JavaScript:** В конец ответа добавляется JS-вызов `moveMapTo(x, y, vcode);`.                             │
 │    24 +             3. Этот вызов, выполненный в `WebView`, инициирует перемещение на следующую клетку маршрута.                           │
 │    25                                                                                                                                      │
 │    22 - ## Решение для портирования на Android                                                                                             │
 │    26 + ### 4. Решение для портирования на Android                                                                                         │
 │    27                                                                                                                                      │
 │    24 - Это одна из самых сложных и важных частей для портирования. Ее реализация тесно связана с портированием классов `Map` и `MapPath`  │
 │       из папки `ExtMap`.                                                                                                                   │
 │    28 + Логика тесно связана с `Map` и `MapPath`, поэтому их портирование (или создание их аналогов `MapRepository` и `MapPath.java`)      │
 │       является обязательным условием. Сам алгоритм `MapAjax` может быть портирован напрямую.                                               │
 │    29                                                                                                                                      │
 │    26 - ## План реализации                                                                                                                 │
 │    30 + - **Архитектура:**                                                                                                                 │
 │    31 +     - Логика будет реализована в методе `process()` класса `postfilter.MapAjax.java`.                                              │
 │    32 +     - Все обращения к статическому `Map` будут заменены на вызовы синглтона `MapRepository.getInstance()`.                         │
 │    33 +     - Логика навигации будет использовать созданный ранее класс-заглушку `MapPath`.                                                │
 │    34                                                                                                                                      │
 │    28 - - [ ] **Предварительный шаг: Портировать `ExtMap`**:                                                                               │
 │    29 -     - [ ] Необходимо сначала полностью портировать классы `Map.cs` (со всеми ячейками карты) и `MapPath.cs` (алгоритм поиска пути  │
 │       A*).                                                                                                                                 │
 │    35 + ### 5. План реализации                                                                                                             │
 │    36                                                                                                                                      │
 │    31 - - [ ] **Создать файл `MapAjax.java`** в пакете `ru.neverlands.abclient.postfilter`.                                                │
 │    37 + 1.  **[ЗАВИСИМОСТЬ] Реализовать `MapRepository` и `MapPath`:**                                                                     │
 │    38 +     - [ ] Наполнить `MapRepository` реальными данными карты (из сконвертированного JSON).                                          │
 │    39 +     - [ ] Реализовать алгоритм поиска пути в `MapPath.java`.                                                                       │
 │    40 + 2.  **Реализовать `MapAjax.java`:**                                                                                                │
 │    41 +     - [ ] Создать метод `process(String html)`.                                                                                    │
 │    42 +     - [ ] Портировать логику парсинга JS-массива `map` с помощью `String.split()`.                                                 │
 │    43 +     - [ ] Портировать логику авто-навигации, заменяя вызовы `Map.*` на `MapRepository.getInstance().*`.                            │
 │    44 +     - [ ] Реализовать логику внедрения JS-кода `moveMapTo(...)` в конец ответа.                                                    │
 │    45 + 3.  **Интегрировать в `MainPhp.java`:**                                                                                            │
 │    46 +     - [ ] В `MainPhp.process()` добавить проверку `if (html.contains("var map = [["))` и вызывать оттуда `MapAjax.process(html)`.  │
 │    47 + 4.  **Обновить `todo_PostFilter.md`:**                                                                                             │
 │    48 +     - [ ] Пометить `MapAjax.cs` как `[x]` проанализированный.                                                                      │
 │    49                                                                                                                                      │
 │    33 - - [ ] **Портировать метод `process(String html)`** (в Java-версии фильтров он обычно принимает `byte[]`, но для удобства можно     │
 │       работать со строкой):                                                                                                                │
 │    34 -     - [ ] Перенести логику парсинга JS-переменной `var map` для получения текущей локации и доступных ходов.                       │
 │    35 -     - [ ] Адаптировать обновление глобального состояния `AppVars`.                                                                 │
 │    36 -     - [ ] Перенести всю логику авто-навигации:                                                                                     │
 │    37 -         - Проверка достижения цели.                                                                                                │
 │    38 -         - Получение следующего шага из портированного `MapPath`.                                                                   │
 │    39 -         - Поиск нужного хода в списке доступных.                                                                                   │
 │    40 -         - Генерация и внедрение вызова `moveMapTo(...)` в HTML.                                                                    │
 │    41 -                                                                                                                                    │
 │    42 - - [ ] **Интегрировать в `Filter.java`**:                                                                                           │
 │    43 -     - [ ] Добавить в `Filter.java` правило для перехвата `map_ajax.php` и вызова `MapAjax.process()`.                              │
 │    44 -                                                                                                                                    │
 │    45 - - [ ] **Обновить `todo_PostFilter.md`**, отметив `MapAjax.cs` как проанализированный.                                              │
 │    50 + - [ ] Поскольку полная реализация `MapRepository` и `MapPath` — это отдельная большая задача, на текущем этапе в `MapAjax.java`    │
 │       будет создана только структура с заглушками вместо реальной логики навигации.           