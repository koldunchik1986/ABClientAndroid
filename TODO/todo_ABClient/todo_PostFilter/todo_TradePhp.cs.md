
### 1. План портирования TradePhp.cs

Файл `TradePhp.cs` не является классическим фильтром. Это ключевая часть логики автоматической торговли (бота), которая анализирует страницу подтверждения сделки (`trade.php`) и принимает решение о покупке или отказе на основе набора правил.

### 2. Функциональность в C#

- **Назначение:** Автоматизировать процесс принятия решений при покупке предметов у других игроков.
- **Логика:**
    1.  **Парсинг информации о сделке:** Извлекает из HTML имя продавца, цену, название предмета, его уровень, текущую/максимальную долговечность и госцену.
    2.  **Расчет реальной госцены:** Корректирует госцену с учетом текущей долговечности.
    3.  **Проверка цены:**
        *   Сравнивает цену продажи с расчетной ценой из `TorgList.Calculate()`. Если цена завышена, сделка отклоняется.
        *   Проверяет, не является ли цена продажи ниже 90% от реальной госцены. Если да, сделка отклоняется.
    4.  **Проверка по списку запрета:** Проверяет, не содержит ли название предмета ключевых слов из списка запрета (`AppVars.Profile.TorgDeny`). Если да, сделка отклоняется.
    5.  **Принятие сделки:** Если все проверки пройдены, бот готовится к покупке.
    6.  **Логика после покупки ("Слив"):**
        *   Проверяет, включена ли опция перепродажи (`AppVars.Profile.TorgSliv`).
        *   Если да, то на основе уровня и названия предмета принимается решение, нужно ли его сразу после покупки продать в госларек (устанавливается флаг `TorgList.TriggerBuy = true`).
    7.  **Отправка сообщений в чат:** Формирует и отправляет сообщения в приватный чат с продавцом (благодарность или причина отказа).
    8.  **Редирект:** Генерирует HTML-код с редиректом на URL для подтверждения или отмены сделки.

### 3. Решение для портирования на Android

Эта логика полностью завязана на состояние C# приложения (`AppVars`, `TorgList`, `Chat`) и его настройки. Прямое портирование в виде javascript-фильтра невозможно. Функциональность должна быть полностью переписана на стороне Android-приложения.

### 4. План реализации

1.  **Создать класс `TradeBot` в Android:**
    - [ ] Этот класс будет инкапсулировать всю логику принятия решений по сделкам.
    - [ ] Он будет хранить настройки, связанные с торговлей (максимальная цена, списки запрета/исключений и т.д.).
2.  **Реализовать обработку ответа от сервера:**
    - [ ] В `WebViewClient` перехватывать загрузку URL, содержащего `trade.php`.
    - [ ] Передавать HTML-содержимое страницы в `TradeBot` для анализа.
3.  **Реализовать логику анализа в `TradeBot`:**
    - [ ] Воспроизвести всю логику парсинга, проверок и принятия решений из C#-кода.
4.  **Обратная связь и действия:**
    - [ ] `TradeBot` должен возвращать результат анализа (например, объект `TradeDecision` с решением `ACCEPT` или `DECLINE` и URL для следующего действия).
    - [ ] `WebViewClient` на основе этого решения выполняет редирект на нужный URL.
    - [ ] Реализовать отправку сообщений в чат через `JavascriptInterface`.

- [ ] Создать класс `TradeBot` для инкапсуляции логики торговли.
- [ ] Реализовать в `WebViewClient` перехват и передачу HTML-кода `trade.php` в `TradeBot`.
- [ ] Реализовать в `TradeBot` полный аналог логики анализа и принятия решений.
- [x] Реализовать выполнение редиректов и отправку сообщений в чат на основе решения `TradeBot`.
