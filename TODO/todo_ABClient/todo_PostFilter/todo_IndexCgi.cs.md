# План портирования IndexCgi.cs

Файл `IndexCgi.cs` является частью `PostFilter` и предназначен для обработки главной страницы входа в игру (`index.cgi` или `www.neverlands.ru/`). Его ключевая задача — автоматизация процесса авторизации.

## Функциональность в C#

1.  **Проверка на страницу авторизации**:
    *   Фильтр сначала ищет в HTML-коде форму с `id="auth_form"`. Если такая форма не найдена, он предполагает, что это не страница входа, и прекращает работу, возвращая исходный HTML.

2.  **Обработка ошибок входа**:
    *   Если на странице присутствует вызов JavaScript-функции `show_warn("...")`, фильтр расценивает это как ошибку авторизации (например, "Неверный пароль" или "Персонаж не найден").
    *   Он извлекает текст ошибки.
    *   С помощью `BeginInvoke` он передает этот текст в основной UI-поток для отображения пользователю.
    *   После этого он возвращает пустой HTML, чтобы скрыть стандартную страницу с ошибкой.

3.  **Автоматическая авторизация**:
    *   Если это страница входа и ошибок нет, фильтр **полностью игнорирует** полученный HTML.
    *   Он генерирует с нуля новую HTML-страницу, содержащую скрытую форму.
    *   В поля этой формы (`player_nick` и `player_password`) подставляются логин и пароль пользователя из `AppVars.Profile`.
    *   С помощью встроенного JavaScript (`document.ff.submit();`) эта форма немедленно отправляется на сервер (`./game.php`).

4.  **Установка флага `WaitFlash`**:
    *   Сразу после генерации страницы для авто-входа, устанавливается флаг `AppVars.WaitFlash = true`. Это является сигналом для следующего обработчика (`GamePhp.process`) о том, что после входа может потребоваться обработка Flash-пароля.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность полностью реализована.
- **Объяснение**:
    1.  В проекте существует класс `app/src/main/java/ru/neverlands/abclient/postfilter/IndexCgi.java`.
    2.  Метод `process()` в этом классе полностью повторяет логику C#-версии: он проверяет наличие `auth_form`, ищет `show_warn`, генерирует и возвращает HTML для авто-логина и устанавливает флаг `AppVars.WaitFlash`.

## Решение для портирования на Android

Никаких действий не требуется.

## План реализации

- [x] **Задача решена.** Функциональность уже существует.
- [x] **Обновить `todo_PostFilter.md`**, отметив `IndexCgi.cs` как проанализированный и реализованный (`[+]`).
