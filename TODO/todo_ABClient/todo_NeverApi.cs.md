# План портирования NeverApi.cs

Файл `NeverApi.cs` - это статический класс, который служит API-клиентом для получения структурированных данных с сервера neverlands.ru.

## Функциональность в C#

*   **Назначение**: Абстрагировать сетевые запросы и парсинг специфичного текстового формата сервера. Предоставляет простые методы для получения данных об игроках и боях.
*   **Ключевые методы**:
    *   `GetAll(string nick)`: Основной метод. Получает ID пользователя по нику, затем по ID запрашивает большой блок данных с `info.cgi`. После этого парсит многострочный ответ с разделителями `|` и заполняет сложный объект `UserInfo`.
    *   `GetUserId(string nick)`: Вспомогательный метод для получения ID по нику с кэшированием результата.
    *   `GetPInfo(string nick)` и `GetFlog(string flog)`: Простые обертки для скачивания HTML-страниц информации о персонаже и лога боя.
*   **Сетевое взаимодействие**: Использует `CookieAwareWebClient` и `IdleManager` для выполнения фоновых HTTP-запросов.

## Проверка на существующую реализацию в Android

- **Результат:** Функциональность не реализована. В проекте есть только упоминание URL `pinfo.cgi`, но отсутствует сам API-клиент и логика парсинга.

## Решение для портирования на Android

Необходимо создать синглтон-класс `NeverApi.java`. Сетевые запросы должны выполняться асинхронно с помощью `OkHttp` (который уже есть в проекте). Логику парсинга нужно будет аккуратно перенести.

## План реализации

- [ ] **Создать файл `NeverApi.java`** в пакете `ru.neverlands.abclient.api` (создать пакет, если его нет).

- [ ] **Реализовать класс как синглтон**.

- [ ] **Портировать метод `getInfo(String url)`**:
    - [ ] Этот приватный метод должен будет выполнять сетевые запросы. Его нужно переписать с использованием `OkHttp`.
    - [ ] Запросы должны быть асинхронными. Метод должен возвращать `String` с результатом или `null` в случае ошибки. Можно использовать корутины Kotlin или `ExecutorService` в Java.
    - [ ] Интегрировать вызовы `IdleManager.getInstance().addActivity()` и `removeActivity()` в `try...finally` вокруг сетевого запроса.

- [ ] **Портировать `getUserId(String nick)`**:
    - [ ] Реализовать кэширование `NameToId` с использованием `ConcurrentHashMap`.
    - [ ] Вызывать `getInfo()` для получения ID.

- [ ] **Портировать `getAll(String nick)`**:
    - [ ] Это будет самый сложный метод. Он должен быть асинхронным.
    - [ ] Сначала вызывать `getUserId`.
    - [ ] Затем вызывать `getInfo` для получения большого блока данных.
    - [ ] Тщательно перенести всю логику парсинга ответа с помощью `String.split("\n")` и `String.split("|")`.
    - [ ] Создать и вернуть объект `UserInfo` (который также необходимо портировать).

- [ ] **Портировать `GetPInfo(String nick)` и `GetFlog(String flog)`**.

- [ ] **Обновить `todo_ABClient.md`**, отметив `NeverApi.cs` как проанализированный.
