# План портирования MapAjax.cs

Файл `MapAjax.cs` (а точнее, метод `MapAjax` внутри `MainPhp.cs`) является ядром системы навигации по карте мира. Он не является самостоятельным фильтром, а вызывается из `MainPhp.cs` при обработке страницы, содержащей данные карты.

## Функциональность в C#

1.  **Парсинг данных карты**:
    *   Извлекает из JavaScript-массива `var map = [...]` ключевую информацию:
        *   Текущие координаты игрока (X, Y).
        *   Время до завершения текущего перехода.
        *   Список всех доступных для перемещения соседних клеток и их "магические коды", необходимые для формирования запроса на переход.
    *   Обновляет глобальное состояние `AppVars`, в частности `AppVars.Profile.MapLocation`.

2.  **Логика авто-перемещения (`AutoMoving`)**:
    *   Это основная задача модуля. Если включен флаг `AppVars.AutoMoving`, модуль выполняет следующий шаг по маршруту.
    *   **Проверка цели**: Если цель достигнута, отключает авто-перемещение.
    *   **Построение маршрута**: Если маршрут еще не построен или устарел, создает новый объект `MapPath`. Этот класс, используя данные из `ExtMap`, строит кратчайший путь от текущей клетки до цели.
    *   **Выполнение перехода**: Получив из `MapPath` следующую клетку, модуль генерирует и внедряет в страницу JavaScript-код `moveMapTo(X, Y, ...);`. Выполнение этого кода инициирует AJAX-запрос на перемещение персонажа.
    *   **Обработка телепортов/городов**: Если следующий шаг — это вход в город или телепорт, модуль ищет на странице соответствующую ссылку и генерирует редирект на нее.

## Зависимости

*   **`MainPhp.cs`**: Этот код является неотъемлемой частью `MainPhp.cs`.
*   **`ExtMap`**: Критически зависит от всего пространства имен `ExtMap` (`Map`, `MapPath`, `Cell`, `Position`), где хранится граф карты и реализованы алгоритмы поиска пути (например, A* или Дейкстры).

## План портирования в Android

Портирование этого модуля — очень сложная задача, которую нельзя выполнить в отрыве от `MainPhp` и `ExtMap`.

**Статус: БЛОКИРОВАНО.**

Портирование `MapAjax` должно быть частью общего плана портирования `MainPhp` (см. `TODO/todo_MainPhp.cs.md`).

**Конкретные шаги в рамках будущего портирования `MainPhp`:**

1.  **Портировать `ExtMap`**: Перенести на Java все классы, связанные с представлением карты (`Map`, `Cell`, `Position`), и, что самое важное, алгоритм поиска пути из `MapPath`.
2.  **Создать `MapAjaxProcessor.java`**: Вынести всю логику из C#-метода `MapAjax` в отдельный Java-класс.
3.  **Реализовать `process(html)`**: Метод будет принимать HTML, парсить его, и если включен `AutoMoving`, выполнять логику навигации.
4.  **Адаптировать генерацию JS**: Вместо простого `Insert`, использовать `webView.evaluateJavascript(...)` для выполнения команды `moveMapTo(...)`.
5.  **Интеграция**: `MainPhp.java` будет вызывать `MapAjaxProcessor.process()` в нужный момент.
