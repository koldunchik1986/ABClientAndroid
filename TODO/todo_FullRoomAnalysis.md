# Полный анализ функциональности "Комнаты" в C# коде

## 1. Введение

Этот документ предоставляет исчерпывающий анализ всех упоминаний и использований, связанных с "комнатой" (Room) в C# коде проекта. Цель - полностью понять, как эта функциональность реализована в оригинальной ПК-версии, чтобы обеспечить качественное портирование на Android.

## 2. Анализ файлов

### 2.1. `RoomManager.cs`

Это центральный класс для управления состоянием игровой комнаты.

- **`RoomManager.StartTracing()` / `StopTracing()`**: Методы для запуска и остановки фонового потока, который отслеживает изменения в комнате.
- **`RoomAsync()`**: Основной метод, работающий в фоновом потоке. Он периодически отправляет запросы на `ch.php`, получает HTML-код комнаты и сравнивает его с предыдущей версией. Если есть изменения, вызывается `Process()`.
- **`Process(string html)`**: Ключевой метод, который выполняет следующие действия:
    - Парсит HTML для извлечения названия локации и списка игроков (`FilterProcRoom`).
    - Определяет вошедших и вышедших игроков (`FilterGetWalkers`).
    - Внедряет CSS для стилизации.
    - Внедряет JavaScript для добавления выпадающего списка быстрой навигации.
    - Добавляет информацию о невидимых игроках и кнопку для их обнаружения.
    - Инициирует автоматические действия (атака, использование свитков).
- **`FilterProcRoom(string html)`**: Парсит массив `ChatListU` из JavaScript в HTML-коде, чтобы получить список игроков и их данные.
- **`HtmlChar(string schar)`**: Генерирует HTML-код для каждого игрока в списке, включая кнопки быстрых действий с вызовами `window.external`.

### 2.2. `ABForms/FormMain*.cs`

Это главная форма приложения, которая тесно взаимодействует с `RoomManager`.

- **`FormMainInit.cs`**: В методе `FormLoad` вызывается `RoomManager.StartTracing()`, что инициирует фоновое отслеживание комнаты.
- **`FormMainCross.cs`**: Содержит метод `UpdateRoom`, который вызывается из `RoomManager` для обновления UI. Этот метод принимает списки игроков и травмированных и обновляет соответствующие элементы на форме.
- **`FormMainDelegates.cs`**: Объявляет делегат `UpdateRoomDelegate`, который используется для безопасного вызова `UpdateRoom` из фонового потока `RoomManager`.
- **`FormMainTabs.cs`**: Определяет `TabType.Room`, который, вероятно, используется для открытия комнаты в отдельной вкладке.

### 2.3. `PostFilter/ChRoomPhp.cs`

- **`ChRoomPhp(byte[] array)`**: Этот метод-фильтр перехватывает ответ от `ch.php`. Он вызывает `RoomManager.Process(html)` для модификации HTML-кода комнаты перед его отображением в `WebView`.

### 2.4. `PostFilter/Filter.cs`

- **`process(string address, byte[] array)`**: Главный метод-фильтр, который определяет, какой фильтр применить к какому URL. Он вызывает `ChRoomPhp` для адресов, содержащих `ch.php?lo=`.

### 2.5. `PostFilter/MainPhp.cs` и `MainPhpRobinHood.cs`

- Эти файлы используют данные, собранные `RoomManager`, для выполнения специфических игровых действий. Например, `MainPhpRobinHood.cs` использует `RoomManager.MyLocation` для получения списка игроков в текущей локации.

### 2.6. `Tabs/TabType.cs`

- **`TabType.Room`**: Простое перечисление, которое идентифицирует тип вкладки как "комната".

## 3. Общая схема работы

1.  При загрузке главной формы (`FormMain`) запускается `RoomManager.StartTracing()`.
2.  `RoomManager` в фоновом потоке начинает циклически запрашивать `ch.php`.
3.  Когда `WebView` в приложении пытается загрузить `ch.php`, `Filter.java` (в Android-версии) перехватывает этот запрос.
4.  В ПК-версии, `Filter.cs` вызывает `ChRoomPhp.cs`, который, в свою очередь, вызывает `RoomManager.Process()`.
5.  `RoomManager.Process()` модифицирует HTML-код `ch.php`, добавляя в него CSS, JavaScript и кнопки быстрых действий.
6.  Модифицированный HTML возвращается в `WebView` и отображается пользователю.
7.  При нажатии на кнопки быстрых действий вызываются методы в `FormMain.cs` через `window.external`, которые выполняют соответствующие игровые действия.

## 4. План дальнейших действий

Как и было указано в `TODO/todo_RoomAnalysis.md`, основная задача - портировать логику из `RoomManager.cs` в `RoomManager.java`. Это включает в себя:

1.  **Реализацию парсинга HTML** для извлечения данных об игроках.
2.  **Генерацию HTML-кода для кнопок** быстрых действий с использованием `AndroidBridge` вместо `window.external`.
3.  **Расширение `WebAppInterface.java`** для обработки вызовов из JavaScript.

Я продолжу работу над реализацией `RoomManager.java` в соответствии с этим планом.