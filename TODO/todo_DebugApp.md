# Комплексная отладка приложения по логам от 2025-10-02

Этот документ отслеживает решение проблем, обнаруженных в `logcat.txt`.

## Общий статус

- [ ] **Критическая проблема:** Устранить падение `WebView` (`NoClassDefFoundError`).
- [ ] **Проблема производительности:** Устранить зависания UI (ANR) в `LoginActivity` и `MainActivity`.
- [ ] **Ошибка в коде:** Исправить синтаксическую ошибку в JavaScript-файле `ch_list.js`.
- [ ] **Прочие проблемы:** Разобраться с менее критичными ошибками и предупреждениями.

---

## 1. Критическая ошибка инициализации WebView

**Проблема:** Приложение не может найти системные классы `android.webkit.PacProcessor` и `android.app.UiModeManager$ContrastChangeListener`, что вызывает `java.lang.NoClassDefFoundError` и приводит к сбою при создании `WebView`.

**Гипотеза:** Код приложения или его зависимости обращаются к API, которые отсутствуют в версии Android или `WebView`, установленной на тестовом устройстве. Это частая проблема при использовании "серых" (непубличных) API.

### План решения

- [ ] **Шаг 1: Анализ `MainActivity.java`**
  - [ ] Прочитать файл `app/src/main/java/ru/neverlands/abclient/MainActivity.java`.
  - [ ] Найти строку `115`, где происходит ошибка (`MainActivity.java:115`), и проанализировать код, связанный с созданием `WebView` и `ActivityMainBinding`.
- [ ] **Шаг 2: Поиск использования проблемных классов**
  - [ ] Выполнить поиск по кодовой базе на предмет упоминания `PacProcessor` и `ContrastChangeListener`, чтобы понять, где они используются.
- [ ] **Шаг 3: Определение версии WebView и Android**
  - [ ] Проверить лог на наличие информации о версии `WebView` (уже найдено: `version 138.0.7204.179`).
  - [ ] Определить версию Android, на которой запускалось приложение (по косвенным признакам или запросить у пользователя).
- [ ] **Шаг 4: Разработка исправления**
  - [ ] Если использование этих классов необходимо, найти совместимый способ реализации или обернуть вызовы в проверки `if (Build.VERSION.SDK_INT >= ...)` для выполнения только на поддерживаемых версиях ОС.
  - [ ] Если использование не критично, удалить его.

---

## 2. Зависания и блокировка основного потока (ANR)

**Проблема:** Главный поток приложения блокируется на длительное время (более 500 мс) при запуске `LoginActivity` и `MainActivity`. Это вызывает пропуск кадров, "зависание" интерфейса и, как следствие, ошибку `InputDispatcher`.

**Гипотеза:** В методах `onCreate` этих Activity выполняются ресурсоемкие операции, такие как работа с базой данных, сетевые запросы или сложная инициализация UI.

### План решения

- [ ] **Шаг 1: Анализ кода `LoginActivity` и `MainActivity`**
  - [ ] Изучить исходный код `onCreate` в обоих Activity.
  - [ ] Обратить особое внимание на строки, упомянутые в логах (`LoginActivity onCreate took 549ms`, `MainActivity onCreate took 836ms`).
- [ ] **Шаг 2: Выявление блокирующих операций**
  - [ ] Найти код, который может долго выполняться: работа с `ThingsRepository` (`Populating from XML...`), инициализация `WebView`, загрузка других ресурсов.
- [ ] **Шаг 3: Оптимизация**
  - [ ] Перенести все долгие операции из основного потока в фоновый (например, с использованием `Thread`, `AsyncTask` или корутин Kotlin).

---

## 3. Ошибка JavaScript в WebView

**Проблема:** В `WebView` возникает ошибка `Uncaught SyntaxError: missing ) after argument list` в файле `http://neverlands.ru/ch/ch_list.js` на строке 156.

**Гипотеза:** В указанном файле допущена синтаксическая ошибка.

### План решения

- [ ] **Шаг 1: Получение и анализ файла `ch_list.js`**
  - [ ] Найти и прочитать файл `ch_list.js` в проекте. Судя по логам, он обрабатывается классом `ChListJs`.
  - [ ] Изучить строку 156 на предмет отсутствующей скобки или другой синтаксической ошибки.
- [ ] **Шаг 2: Исправление**
  - [ ] Внести необходимые исправления в файл `ch_list.js`.

---

## 4. Прочие ошибки и предупреждения

Здесь перечислены менее критичные, но важные для исправления проблемы.

- **`SELinux: setxattr failed`**: Проблема с правами доступа в окружении MIUI. Вероятно, не требует исправления в коде, но стоит иметь в виду.
- **`Access denied finding property "vendor.camera.aux.packagelist"`**: Приложение пытается получить доступ к свойствам камеры без необходимых разрешений.
- **`Ignoring header Cookie because its value was null`**: Попытка выполнить сетевой запрос с пустым Cookie. Нужно проверить логику управления сессиями.
- **`A resource failed to call end`**: Утечка ресурсов. Необходимо найти `Closeable` объекты, которые не закрываются должным образом.
- **`Accessing hidden ... (light greylist, reflection)`**: Использование непубличных API. Необходимо найти все такие вызовы и заменить их на безопасные аналоги из публичного SDK.
