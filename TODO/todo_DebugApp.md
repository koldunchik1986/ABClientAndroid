# Комплексная отладка и разработка

## Список задач

- [x] **Проблема:** Ошибки JavaScript при навигации между комнатами.
  - **Симптомы:**
    - `Uncaught TypeError: Cannot set properties of undefined (setting 'location')`
    - `Uncaught ReferenceError: cha_HP is not defined`
    - `Uncaught ReferenceError: ins_HP is not defined`
  - **Гипотеза:**
    1.  Отсутствие заглушек для JavaScript-функций `cha_HP` и `ins_HP`.
    2.  Некорректная эмуляция фреймовой структуры сайта. JavaScript-код пытается получить доступ к фреймам (`top.frames[...]`), которые не существуют в контексте WebView, что приводит к ошибке `setting 'location'`.
  - **План решения:**
    - [x] **Шаг 1:** Добавить заглушки для `cha_HP` и `ins_HP` в метод `injectJsFix` в `MainActivity.java`.
    - [x] **Шаг 2:** Создать в `injectJsFix` JavaScript-объект `top.frames`, который будет имитировать структуру фреймов.
    - [x] **Шаг 3:** Для каждого ожидаемого фрейма (`ch_buttons`, `ch_refr`, `ch_list`, `chmain`, `main_top`) создать объект-заглушку.
    - [x] **Шаг 4:** Реализовать для каждого объекта-заглушки сеттер для свойства `location`. Этот сеттер должен вызывать `AndroidBridge` для передачи URL и имени фрейма в Java-код.
    - [x] **Шаг 5:** Реализовать в `WebAppInterface` метод, который будет принимать URL и имя фрейма и загружать его в соответствующий `WebView`.

- [x] **Проблема:** Игровой фрейм не обновляется при навигации по комнатам.
  - **Симптомы:** При переходе по ссылкам в игре, основной фрейм (`main_top`) не обновляет свое содержимое, оставаясь на первоначальной комнате. В некоторых случаях вместо контента отображается белый экран.
  - **Гипотеза:** Проблема может быть связана с несколькими факторами: некорректная работа `shouldInterceptRequest`, проблемы с кешированием, ошибки в жизненном цикле `WebView` или отсутствие правильной обработки cookies.
  - **План решения:**
    - [x] **Шаг 1:** Проанализированы логи вызовов `WebAppInterface.loadFrame`, которые подтвердили, что URL для загрузки передаются корректно.
    - [x] **Шаг 2:** Временно удален метод `shouldInterceptRequest`, что привело к улучшению навигации, но отключило кеширование и модификацию контента.
    - [x] **Шаг 3:** Восстановлен `shouldInterceptRequest` с логикой перехвата только `.js` файлов. Это не решило проблему, так как HTML-страницы, содержащие ошибки, не обрабатывались.
    - [x] **Шаг 4:** Расширена логика `shouldInterceptRequest` для перехвата и обработки HTML-файлов (`.php`, `/`).
    - [x] **Шаг 5:** Добавлена проверка кода ответа сервера в `shouldInterceptRequest`. Если код не 200, запрос не обрабатывается, что предотвращает загрузку страниц с ошибками в `WebView`.
    - [x] **Шаг 6:** Добавлена передача cookies в `HttpURLConnection` в `shouldInterceptRequest` для правильной аутентификации.
    - [x] **Шаг 7:** В `injectJsFix` добавлен прокси для `window.external`, чтобы он указывал на `window.AndroidBridge`.
    - [x] **Шаг 8:** В `onPageFinished` добавлена инъекция `jsFix` для всех основных фреймов, чтобы гарантировать наличие необходимых заглушек и объектов до выполнения игровых скриптов.

- [ ] **Проблема:** При навигации по комнатам, где в ответе сервера есть тег `<script>`, верхний фрейм не отображает HTML-контент.
  - **Симптомы:** После клика на кнопку навигации, в логах видно, что `shouldInterceptRequest` перехватывает ответ, содержащий HTML и JavaScript, но `WebView` не отображает этот контент.
  - **Гипотеза:** Проблема может быть связана с тем, как `WebView` обрабатывает ответы, содержащие и HTML, и JavaScript. Возможно, `loadDataWithBaseURL` или другой метод загрузки контента в `WebView` не выполняет JavaScript в контексте загружаемой страницы.
  - **План решения:**
    - [ ] **Шаг 1:** Проанализировать, как именно `shouldInterceptRequest` возвращает данные в `WebView`. Убедиться, что используется правильный `mime-type` и кодировка.
    - [ ] **Шаг 2:** Попробовать заменить `loadUrl` на `loadDataWithBaseURL` в `WebAppInterface.loadFrame`, чтобы явно указать `baseUrl` и `mimeType`.
    - [ ] **Шаг 3:** Исследовать возможность выполнения JavaScript из ответа сервера в `onPageFinished` после загрузки основного HTML-контента.
