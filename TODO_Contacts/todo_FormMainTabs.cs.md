# Анализ файла: ABForms/FormMainTabs.cs

## 1. Назначение файла

Этот файл является частью `partial` класса `FormMain` и содержит всю логику, связанную с управлением вкладками в приложении. Он отвечает за создание, закрытие и управление жизненным циклом вкладок, в каждой из которых может быть размещен браузерный компонент.

## 2. Анализ логики

### `BeforeNewWindow(string tourl, ...)`

Это ключевой метод, который служит точкой входа для открытия новых вкладок. Он вызывается, когда браузерный компонент `ExtendedWebBrowser` инициирует событие `BeforeNewWindow`, что является прямым аналогом `onCreateWindow` в `WebChromeClient` на Android.

*   **Маршрутизация URL**: Метод анализирует запрошенный URL (`tourl`) и на основе него решает, какой тип вкладки создать. Для `pinfo.cgi` используется следующая логика:
    ```csharp
    if (tourl.StartsWith(Resources.AddressPInfo, StringComparison.OrdinalIgnoreCase))
    {
        CreateNewTab(TabType.PInfo, tourl, delayed);
        return;
    }
    ```

### `CreateNewTab(TabType tt, string tourl, ...)`

Это основной метод, который создает новую вкладку. Он выполняет следующие действия:

1.  Создает новую `TabPage`.
2.  Создает новый экземпляр `ExtendedWebBrowser` для размещения на этой вкладке.
3.  Создает `ToolStrip` (панель инструментов) для вкладки.
4.  **Добавляет контекстные кнопки**: В зависимости от типа вкладки (`TabType`), на панель инструментов добавляются разные кнопки. **Это важный момент для портирования.**

### Контекстные кнопки для `PInfo`

Когда создается вкладка типа `TabType.PInfo`, в ее панель инструментов добавляются следующие кнопки для взаимодействия с персонажем, информация о котором отображается:

*   **`buttoncompas`**: "Компас" (поиск на природе).
*   **`buttonprivate`**: "Приват" (написать личное сообщение).
*   **`buttoncontact`**: "В контакты" (добавить персонажа в список контактов).
*   **`buttonAddClan`**: "Весь клан" (добавить весь клан персонажа в контакты).

Каждая кнопка имеет свой обработчик (`buttonCompas_Click`, `buttonPrivate_Click` и т.д.), который выполняет соответствующее действие.

## 3. План портирования на Android

1.  **Аналог `BeforeNewWindow`**: Как и планировалось, логика должна быть реализована в `MainActivity` в методе `onCreateWindow` у `WebChromeClient`.

2.  **Аналог вкладок**: Вместо системы вкладок, которая плохо подходит для мобильного интерфейса, будет использоваться отдельная `Activity` (`PinfoActivity`), что является правильной адаптацией.

3.  **Портирование контекстных кнопок**: Это новая, ранее не учтенная задача. Функционал этих кнопок необходимо воспроизвести в Android-версии.
    *   **Решение**: В `PinfoActivity` следует добавить `ActionBar` (или `Toolbar`).
    *   В меню для этой `Activity` (`res/menu/pinfo_menu.xml`) нужно добавить пункты, соответствующие кнопкам "Приват", "В контакты" и т.д.
    *   В `PinfoActivity.java` необходимо будет реализовать обработчики для этих пунктов меню (`onOptionsItemSelected`), которые будут выполнять соответствующие действия (например, открывать диалог для приватного сообщения, добавлять ник в `AppVars.Profile.contacts` и т.д.).

## 4. Выводы

*   Анализ подтвердил, что `onCreateWindow` в Android — правильное место для реализации логики.
*   Выявлена **новая подзадача**: реализация контекстных кнопок, которые присутствуют в оригинальном клиенте на вкладке с информацией о персонаже. Эту функциональность необходимо добавить в план в `TODO/todo_pinfo.md`.
