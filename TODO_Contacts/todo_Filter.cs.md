# Анализ файла: PostFilter/Filter.cs

## 1. Назначение файла

`Filter.cs` — это центральный статический класс, отвечающий за **пост-фильтрацию** HTTP-ответов, полученных от сервера. Он выступает в роли диспетчера, который анализирует URL запрошенного ресурса и, в зависимости от него, применяет различные модификации к телу ответа (HTML, JS и т.д.) перед тем, как отдать его браузерному движку.

Это C#-аналог логики, которая в Android-версии находится в `shouldInterceptRequest`.

## 2. Анализ логики

Основной метод — `public static byte[] Process(string address, byte[] array)`.

1.  **Диспетчеризация по URL**: Метод содержит большую цепочку `if` / `else if` конструкций, которые проверяют `address` на соответствие различным URL-шаблонам.

2.  **Модификация JavaScript**: Существует большой блок, посвященный обработке `.js` файлов. В зависимости от имени файла (`hp.js`, `map.js`, `ch_list.js` и т.д.) вызывается соответствующий метод-обработчик (например, `HpJs(array)`, `ChListJs()`). Это подтверждает, что клиент активно изменяет логику скриптов "на лету".

3.  **Модификация HTML**: Аналогично обрабатываются и HTML-страницы (`.php`, `.cgi`). Например, для `main.php` вызывается `MainPhp(address, array)`.

### Обработка `pinfo.cgi`

В файле есть два блока, относящихся к `pinfo.cgi`:

*   **Первый блок**:
    ```csharp
    if (address.StartsWith("http://www.neverlands.ru/pinfo.cgi", StringComparison.OrdinalIgnoreCase))
    {
        return RemoveDoctype(array);
    }
    ```
    *   **Логика**: Если URL начинается с адреса страницы информации о персонаже, к ней применяется функция `RemoveDoctype`. Эта функция удаляет объявление `<!DOCTYPE ...>` из HTML-кода. Вероятно, это делается для упрощения дальнейшего парсинга DOM или для предотвращения включения специфичного режима рендеринга в браузере.

*   **Второй блок**:
    ```csharp
    if (address.StartsWith(Resources.AddressPInfo))
    {
        return Pinfo(array);
    }
    ```
    *   **Логика**: `Resources.AddressPInfo`, скорее всего, содержит ту же строку `http://www.neverlands.ru/pinfo.cgi?`. Этот блок вызывает метод `Pinfo(array)`. Так как класс `Filter` объявлен как `partial`, реализация метода `Pinfo` находится в другом файле (вероятно, `PostFilter/Filter.Pinfo.cs`). Это говорит о том, что над страницей информации о персонаже производятся и другие, более сложные модификации.

## 3. План портирования на Android

При реализации функционала `pinfo` в Android необходимо учесть следующие моменты:

1.  **Аналог `Process`**: Вся логика диспетчеризации уже реализована в `MainActivity.CustomWebViewClient.shouldInterceptRequest`. Именно здесь, после получения ответа от сети или из кэша, нужно будет применять аналогичные фильтры.

2.  **Удаление Doctype**: Если новая `PinfoActivity` будет испытывать проблемы с отображением или парсингом страницы, первым делом нужно будет реализовать аналог `RemoveDoctype` для ответа от `pinfo.cgi`.

3.  **Анализ `Filter.Pinfo.cs`**: Необходимо найти и проанализировать файл, содержащий метод `Pinfo(array)`, чтобы понять, какие еще модификации выполняются над страницей. Вероятно, они связаны с добавлением кнопок, ссылок или другой кастомной логики, которую также потребуется воспроизвести в Android-версии.

## 4. Зависимости

*   `MyHelpers.Russian`: Используется для конвертации `byte[]` в строку и обратно в кодировке `windows-1251`.
*   `System.Text.RegularExpressions.Regex`: Используется для удаления DOCTYPE.
*   Другие части `partial` класса `Filter` (например, `Filter.Pinfo.cs`), где реализованы специфичные для страниц методы.
