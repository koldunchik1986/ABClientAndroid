# Анализ файла: Js/ch_list.js

## 1. Назначение файла

Этот JavaScript-файл отвечает за динамическое формирование и отображение списка пользователей в чате. Основная логика заключена в функции `chatlist_build`.

## 2. Анализ логики

1.  **Источник данных**: Функция `chatlist_build` итерирует по глобальному JavaScript-массиву `ChatListU`, который, по-видимому, инициализируется в HTML-коде страницы до вызова этого скрипта. Каждый элемент `ChatListU` содержит информацию об одном пользователе в чате (ник, клан, уровень и т.д.).

2.  **Генерация HTML**: Скрипт проходит по массиву и для каждого пользователя генерирует строку HTML-кода, которая включает в себя его ник, клановый значок, значок молчанки и другие элементы.

3.  **Интеграция с C#**: Скрипт активно взаимодействует с C#-кодом через `window.external`. Например, `window.external.GetClassIdOfContact(login)` используется для определения, является ли пользователь в списке другом или врагом, чтобы раскрасить его ник в соответствующий цвет.

### Реализация ссылки на `pinfo`

Ключевой для нашей задачи является строка, которая добавляет иконку информации (`info.gif`) после ника пользователя. Эта иконка является ссылкой.

```javascript
// ... (код для генерации ника и уровня) ...
"]</font><a href="/pinfo.cgi?" + nn_sec + "" target=_blank><img src=http://image.neverlands.ru/chat/info.gif width=11 height=12 border=0 align=absmiddle></a>" + ...
```

*   **`href`**: Ссылка ведет на относительный путь `/pinfo.cgi?` с ником пользователя в качестве параметра (`nn_sec` — это обработанный для URL ник).
*   **`target=_blank`**: Атрибут `target=_blank` является стандартным способом указать браузеру, что ссылку нужно открыть в новой вкладке или окне.

## 3. План портирования на Android

1.  **Инъекция скрипта**: Этот скрипт, как и другие, модифицируется и инъецируется в `WebView` через систему пост-фильтрации. В Android-версии это происходит в `MainActivity.CustomWebViewClient`.

2.  **`window.external`**: Все вызовы `window.external` должны быть заменены на вызовы к JavaScript-интерфейсу, который в Android-проекте называется `AndroidBridge`. Например, `window.external.GetClassIdOfContact(login)` становится `AndroidBridge.GetClassIdOfContact(login)`.

3.  **Обработка `target=_blank`**: Самая важная часть. Поскольку этот скрипт сам генерирует ссылку с `target=_blank`, задача Android-приложения — не сгенерировать ее, а **правильно обработать клик по ней**. Это подтверждает, что основная логика для реализации этой фичи должна находиться в `WebChromeClient.onCreateWindow` в `MainActivity.java`, как и было запланировано в `TODO/todo_pinfo.md`.

## 4. Выводы

Анализ этого файла подтверждает, что:
-   Функционал "инфо о персонаже" — это не отслеживание двойного клика, а переход по обычной гиперссылке.
-   Ключевым триггером для открытия нового "окна" является атрибут `target=_blank` в этой ссылке.
-   Задача сводится к корректной обработке этого события в `WebChromeClient`.
