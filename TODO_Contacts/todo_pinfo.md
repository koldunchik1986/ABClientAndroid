# План реализации: Информация о персонаже (pinfo)

## 1. Анализ функциональности в ПК C# версии

Изначальное предположение о двойном клике было неверным. Анализ кода показал, что функционал реализован через вставку иконки-ссылки в HTML-код рядом с никами персонажей.

### Ключевые моменты:

1.  **Способ реализации**: В различных частях интерфейса (чат, списки боев и т.д.) рядом с ником персонажа динамически добавляется иконка `info.gif`. Эта иконка является гиперссылкой (`<a>`).
2.  **URL ссылки**: `http://neverlands.ru/pinfo.cgi?{ник}`.
3.  **Атрибут `target`**: В ссылке используется атрибут `target=_blank`, который в стандартном браузере указывает на открытие ссылки в новой вкладке.
4.  **Инъекция ссылки**: За вставку ссылок отвечают JavaScript-файлы (`arena_v04.js`, `ch_list.js`) и, возможно, пост-фильтры на стороне C# (`PostFilter/Filter.cs`), которые модифицируют HTML-ответы от сервера.
5.  **Обработка в клиенте**: В ПК-версии открытие новой вкладки обрабатывается специальной логикой (вероятно, в `FormMainTabs.cs`).

### Ключевые файлы для анализа:

*   `ABClient/PostFilter/Filter.cs`: Центральный файл, который, скорее всего, управляет применением JS-патчей.
*   `ABClient/Js/arena_v04.js`, `ABClient/Js/ch_list.js`: Примеры JS-файлов, которые вставляют ссылки.
*   `ABClient/ABForms/FormMainTabs.cs`: Для понимания того, как в оригинальном клиенте реализована логика "вкладок".

## 2. Предлагаемое решение для Android

Задача сводится к корректной обработке запроса на открытие окна по ссылке с `target=_blank`.

### Новая активность: `PinfoActivity.java`

-   **Назначение**: Будет содержать один `WebView` для отображения страницы с информацией о персонаже.
-   **UI (`activity_pinfo.xml`):** Простой layout с `WebView`, занимающим весь экран.

### Модификация `MainActivity.java`

Вся логика будет сосредоточена в `WebChromeClient`, который устанавливается для основного `WebView`.

1.  **Переопределение `onCreateWindow`**: Необходимо переопределить метод `onCreateWindow` в анонимном классе `WebChromeClient` внутри `MainActivity.setupWebView`.
2.  **Логика `onCreateWindow`**:
    *   Этот метод вызывается, когда JavaScript пытается открыть новое окно (например, через `window.open` или ссылку с `target=_blank`).
    *   Внутри метода мы **не будем создавать новое окно**, а вместо этого перехватим URL, который должен был в нем открыться.
    *   Получаем запрошенный URL из сообщения, переданного в метод.
    *   Создаем новый `Intent` для запуска `PinfoActivity`.
    *   Добавляем URL в `Intent` в качестве extra-данных.
    *   Запускаем `PinfoActivity`.

### Логика `PinfoActivity.java`

1.  В `onCreate` получить URL из `Intent`.
2.  Настроить свой `WebView`.
3.  Загрузить полученный URL.

## 3. План реализации

- [x] **Задача 1: Анализ исходного кода**
    - [x] Проанализировать `ABClient/PostFilter/Filter.cs` -> `TODO/PostFilter/todo_Filter.cs.md`.
    - [x] Проанализировать `ABClient/Js/ch_list.js` -> `TODO/Js/todo_ch_list.js.md`.
    - [x] Проанализировать `ABClient/ABForms/FormMainTabs.cs` -> `TODO/ABForms/todo_FormMainTabs.cs.md`.

- [x] **Задача 2: Создание UI для `PinfoActivity`**
    - [x] Создать layout-файл `activity_pinfo.xml` с `WebView`.
    - [x] Создать menu-файл `res/menu/pinfo_menu.xml` для контекстных кнопок.

- [x] **Задача 3: Реализация `PinfoActivity.java`**
    - [x] Создать класс `PinfoActivity.java`.
    - [x] Реализовать получение URL из `Intent` и его загрузку в `WebView`.
    - [x] Реализовать `ActionBar` с кнопками из `pinfo_menu.xml`.
    - [x] Реализовать обработчики нажатий на кнопки (Приват, В контакты и т.д.).

- [x] **Задача 4: Модификация `MainActivity.java`**
    - [x] В методе `setupWebView` найти `setWebChromeClient`.
    - [x] Переопределить в нем метод `onCreateWindow`.
    - [x] Реализовать логику перехвата URL и запуска `PinfoActivity`.

- [x] **Задача 5: Интеграция и манифест**
    - [x] Добавить `PinfoActivity` в `AndroidManifest.xml`.
