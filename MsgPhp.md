# Портирование `MsgPhp.cs` в `MsgPhp.java`

## Анализ `MsgPhp.cs` (ПК версия)

Файл `MsgPhp.cs` в оригинальном C# клиенте отвечает за обработку HTML-содержимого, загружаемого из `msg.php`. Основная задача этого фильтра — модифицировать HTML-код для обеспечения корректного отображения и взаимодействия в контексте клиента.

Ключевые изменения, выполняемые `MsgPhp.cs`:

1.  **Замена ссылок на смайлы:** Изменяет абсолютные URL-адреса смайлов (`http://image.neverlands.ru/chat/smiles/`) на относительные пути к локальным ресурсам Android (`file:///android_asset/Icons/Smiles/`). Это позволяет отображать смайлы, которые были скопированы в папку `assets` Android-приложения.
2.  **Инъекция `window.external` обработчиков:** Заменяет стандартные JavaScript-вызовы функций типа `show_info('...')` на `window.external.ShowInfo('...')`. Это критически важный механизм для взаимодействия между JavaScript-кодом, выполняющимся в `WebView`, и нативным Java/Kotlin кодом Android-приложения. Через `window.external` нативный код может перехватывать и обрабатывать события, такие как клики по ссылкам на персонажей, кланы, предметы и т.д., предоставляя более глубокую интеграцию и функциональность, недоступную в стандартном браузере.

## Портирование в `MsgPhp.java` (Android версия)

Логика из `MsgPhp.cs` была перенесена в статический метод `process` класса `MsgPhp.java` в пакете `ru.neverlands.abclient.postfilter`.

### Особенности реализации в Java:

*   **Кодировка:** Для преобразования массива байт в строку и обратно используется `Russian.Codepage.getString()` и `Russian.Codepage.getBytes()`, что обеспечивает корректную работу с кодировкой `windows-1251`, как и в оригинальной C# версии.
*   **Замены строк:** Все операции `html.Replace()` из C# были напрямую перенесены в Java с использованием метода `String.replace()`.
*   **`window.external`:** Инъекция `window.external.Show...Info()` сохранена. Для полноценной работы этой функциональности необходимо убедиться, что в `WebView` Android-приложения настроен `JavascriptInterface`, который предоставляет соответствующие методы (`ShowInfo`, `ShowClanInfo` и т.д.) для вызова из JavaScript.

### Интеграция с `Filter.java`:

Метод `processMsgPhp` в `ru.neverlands.abclient.postfilter.Filter.java` был изменен для вызова `MsgPhp.process(array)`, что позволяет централизованному фильтру делегировать обработку `msg.php` специализированному классу.

## Вывод

Портирование `MsgPhp.cs` в `MsgPhp.java` обеспечивает корректное отображение смайлов и устанавливает механизм взаимодействия между веб-контентом и нативным Android-приложением для обработки различных игровых ссылок. Это важный шаг для восстановления полной функциональности чата и других интерактивных элементов.
