# Инструкция по работе дискового кэша

## 1. Общая архитектура

Система кэширования в приложении является многоуровневой и служит для минимизации сетевых запросов и ускорения загрузки ресурсов. Запросы обрабатываются в следующем порядке:

1.  **Кэш в `assets`**: Первым делом проверяется наличие ресурса в `assets` приложения. Это позволяет иметь "встроенные" ресурсы, которые доступны сразу после установки.
2.  **Дисковый кэш (`abcache`)**: Если ресурс не найден в `assets`, происходит обращение к дисковому кэшу в папке `abcache`. Здесь хранятся ресурсы, загруженные из сети во время предыдущих сессий.
3.  **Сетевой запрос**: Если ресурс отсутствует в обоих кэшах, выполняется полноценный сетевой запрос.

Вся эта логика оркестрируется методом `shouldInterceptRequest` в классе `MainActivity.CustomWebViewClient`.

## 2. Ключевые классы и методы

### `proxy/DiskCacheManager.java`

Этот класс инкапсулирует всю логику по работе с дисковым кэшем.

*   **Назначение**: Управляет чтением и записью файлов в директорию `abcache`.
*   **Расположение папки кэша**: `context.getExternalFilesDir("abcache")`.

#### Статические методы:

*   `public static void init(Context context)`
    *   **Описание**: Инициализирует менеджер кэша. Создает папку `abcache`, если она не существует.
    *   **Вызывается из**: `ABClientApplication.onCreate()`.
    *   **Зависимости**: `android.content.Context`.

*   `public static byte[] get(String url)`
    *   **Описание**: Пытается найти и прочитать ресурс из кэша по его URL.
    *   **Логика**:
        1.  Извлекает `host` (например, `image.neverlands.ru`) и `path` (например, `/exit.gif`) из URL с помощью `android.net.Uri`.
        2.  Формирует относительный путь к файлу, объединяя хост и путь: `host + path` (например, `image.neverlands.ru/exit.gif`).
        3.  Создает объект `java.io.File` для доступа к файлу внутри директории `cacheDir`.
        4.  Если файл существует, читает его в `byte[]` с помощью `java.io.FileInputStream` и возвращает.
        5.  В противном случае возвращает `null`.

*   `public static void put(String url, byte[] data)`
    *   **Описание**: Сохраняет полученные из сети данные (`data`) в дисковый кэш.
    *   **Логика**:
        1.  Аналогично методу `get`, формирует путь к файлу на основе хоста и пути URL.
        2.  Создает все необходимые родительские директории (`parent.mkdirs()`).
        3.  Записывает `byte[]` в файл с помощью `java.io.FileOutputStream`.

### `MainActivity.java` (вложенный класс `CustomWebViewClient`)

Это "сердце" системы кэширования, которое решает, откуда загружать ресурс.

#### Метод `shouldInterceptRequest(WebView view, WebResourceRequest request)`

*   **Описание**: Перехватывает каждый сетевой запрос, исходящий из `android.webkit.WebView`.
*   **Логика работы**:
    1.  **Проверка навигации**: В первую очередь проверяется, не является ли URL навигационным (см. `Instruction/Buttons/ButClick.md`). Если да (`url.contains("main.php?get_id=")`), метод возвращает `null`, позволяя `WebView` обработать запрос самостоятельно.
    2.  **Поиск в `assets`**: Делается попытка прочитать файл из `assets` с помощью `android.content.res.AssetManager`.
        *   Если успешно, ресурс возвращается в виде `android.webkit.WebResourceResponse`.
    3.  **Поиск в дисковом кэше**: Если в `assets` файла нет, вызывается `DiskCacheManager.get(url)`.
        *   Если `DiskCacheManager` вернул данные, они обрабатываются пост-фильтрами (`postfilter.Filter.process`) и возвращаются в `WebView`.
    4.  **Сетевой запрос**: Если ресурс не найден ни в одном из кэшей, выполняется сетевой запрос через `java.net.HttpURLConnection`.
        *   После успешного получения ответа, данные **сохраняются в дисковый кэш** с помощью `DiskCacheManager.put(url, data)`.
        *   Данные обрабатываются пост-фильтрами и возвращаются в `WebView`.

#### Метод `isCacheable(String url)`

*   **Описание**: Вспомогательный метод, который определяет, следует ли вообще кэшировать ресурс по его URL.
*   **Логика**: Возвращает `true` для файлов с определенными расширениями (`.gif`, `.jpg`, `.js` и т.д.) и для некоторых страниц `.php`.

## 3. Зависимости

*   **`ABClientApplication`**: Инициализирует `DiskCacheManager` при старте приложения.
*   **`MainActivity$CustomWebViewClient`**: Использует `DiskCacheManager` для получения и сохранения ресурсов.
*   **`postfilter.Filter`**: Применяется для обработки данных (как из кэша, так и из сети) перед их отображением.
*   **`android.net.Uri`**: Используется для парсинга URL и получения хоста/пути.
*   **`java.io.File`**, **`java.io.FileInputStream`**, **`java.io.FileOutputStream`**: Используются для файловых операций в `DiskCacheManager`.