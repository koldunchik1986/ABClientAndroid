# Анализ и архитектура кэширования

## 1. Общая схема

Кэширование в приложении реализовано по стратегии **"Asset-First"** (Сначала `assets`). Это означает, что для определенных типов ресурсов приложение сначала пытается загрузить их из локальных `assets`, и только в случае неудачи обращается к сети. Этот механизм является частью логики `shouldInterceptRequest` в `MainActivity`.

**Основная цель:**
-   Значительно сократить сетевой трафик, не загружая каждый раз одни и те же статические файлы (JS, CSS, изображения).
-   Ускорить первоначальную загрузку и отрисовку `WebView`, так как доступ к локальным файлам намного быстрее, чем к сети.
-   Обеспечить частичную работоспособность интерфейса даже при медленном или нестабильном соединении.

## 2. Пошаговый алгоритм

### Шаг 1: Перехват запроса
-   **Файл:** `MainActivity.java` (внутренний класс `CustomWebViewClient`)
-   **Механизм:** Метод `shouldInterceptRequest` вызывается для каждого ресурса, который `WebView` пытается загрузить.

### Шаг 2: Попытка чтения из `assets`
-   **Механизм:** В самом начале метода `shouldInterceptRequest` происходит попытка прочитать файл из `assets`.
-   **Логика:**
    1.  Из URL запроса извлекается путь к файлу. Пример: из `http://neverlands.ru/ch/ch_list.js` получается `ch/ch_list.js`.
    2.  Вызывается внутренний метод `readAssetFile(fileName)`.
    3.  `readAssetFile` использует `AssetManager` для открытия и чтения файла по указанному пути.
-   **Результат:**
    -   **Успех:** Если `readAssetFile` успешно находит и читает файл, его байтовое содержимое (`byte[] data`) возвращается. Затем определяется MIME-тип с помощью `getMimeTypeFromUrl(url)`, и создается `WebResourceResponse`. **Сетевой запрос на этом завершается.**
    -   **Неудача:** Если `readAssetFile` выбрасывает `IOException` (например, `FileNotFoundException`), это означает, что файла нет в `assets`. Блок `catch` перехватывает исключение, и выполнение переходит к следующему этапу — выполнению реального сетевого запроса.

### Шаг 3: Определение MIME-типа
-   **Файл:** `MainActivity.java`
-   **Механизм:** Вспомогательный метод `getMimeTypeFromUrl(String url)` используется для определения MIME-типа на основе расширения файла в URL.
-   **Примеры правил:**
    -   `.css` -> `text/css`
    -   `.js` -> `application/javascript`
    -   `.jpg` -> `image/jpeg`
    -   `.php` или без расширения -> `text/html`

## 3. Ключевые классы и методы

-   `MainActivity$CustomWebViewClient.shouldInterceptRequest`: Основной метод, реализующий логику.
-   `MainActivity.readAssetFile(String fileName)`: Вспомогательный метод для чтения байтов из файла в `assets`.
-   `MainActivity.getMimeTypeFromUrl(String url)`: Вспомогательный метод для определения MIME-типа.
-   `android.content.res.AssetManager`: Стандартный Android-класс для доступа к `assets`.

## 4. Что кэшируется?

Кэшируются все файлы, которые были вручную помещены в папку `app/src/main/assets/` с сохранением оригинальной структуры путей (например, `app/src/main/assets/ch/ch_list.js`). Это в основном статическое содержимое:

-   Ключевые JavaScript-файлы (`game.js`, `ch_list.js`, и т.д.)
-   CSS-стили
-   Изображения интерфейса
