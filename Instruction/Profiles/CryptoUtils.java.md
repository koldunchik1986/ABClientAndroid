# Анализ и архитектура `CryptoUtils.java`

**Файл:** `app/src/main/java/ru/neverlands/abclient/utils/CryptoUtils.java`

## 1. Назначение

`CryptoUtils` — это статический класс-утилита, предоставляющий методы для шифрования и дешифровки паролей. Его реализация **полностью идентична** логике шифрования в оригинальном C# клиенте, что обеспечивает полную совместимость зашифрованных профилей между ПК и Android версиями.

## 2. Алгоритм и параметры

-   **Основной алгоритм шифрования:** `DESede/CBC/PKCS5Padding` (TripleDES).
-   **Алгоритм генерации ключа:** `PBKDF2WithHmacSHA1`. Это стандарт генерации ключа на основе пароля (Password-Based Key Derivation Function 2), который в .NET представлен классом `Rfc2898DeriveBytes`.

### Ключевые константы для совместимости с C#:
-   `private static final byte[] SALT`: Жестко заданная "соль" в виде байтового представления строки `"Ivan Medvedev"`. Использование одной и той же соли в C# и Java является обязательным условием для генерации одинаковых ключей из одного и того же пароля.
-   `private static final int ITERATION_COUNT = 1000`: Количество итераций для алгоритма PBKDF2. Соответствует значению по умолчанию в .NET.
-   `private static final int KEY_LENGTH_BITS = 128`: Длина генерируемого ключа (16 байт).
-   `private static final int IV_LENGTH_BYTES = 8`: Длина вектора инициализации (IV) для TripleDES.
-   `private static final Charset CODEPAGE = Charset.forName("windows-1251")`: Кодировка, в которой исходный текст (пароль) преобразуется в байты перед шифрованием и обратно после дешифровки.

## 3. Процесс шифрования/дешифровки

Методы `encrypt` и `decrypt` работают по симметричной схеме.

1.  **Генерация ключа и вектора (Key & IV):**
    -   Из пароля пользователя (`String password`), `SALT` и `ITERATION_COUNT` с помощью `PBEKeySpec` и `SecretKeyFactory` генерируется единый массив байт длиной 24 байта (`KEY_LENGTH_BITS/8 + IV_LENGTH_BYTES`).
    -   Первые 16 байт этого массива используются как ключ (`keyBytes`).
    -   Следующие 8 байт используются как вектор инициализации (`ivBytes`).

2.  **Совместимость ключа TripleDES (.NET vs Java):**
    -   Это **критически важный** шаг для совместимости. Java `DESede` требует 24-байтный ключ. .NET `TripleDES` может работать с 16-байтным ключом, автоматически расширяя его до 24 байт путем добавления первых 8 байт в конец (`key[16..23] = key[0..7]`).
    -   Код в `CryptoUtils.java` вручную имитирует это поведение, создавая 24-байтный массив `tripleDesKeyBytes` и копируя в него байты ключа по той же схеме.

3.  **Шифрование/Дешифровка:**
    -   Инициализируется `javax.crypto.Cipher` с алгоритмом `DESede/CBC/PKCS5Padding`.
    -   В качестве параметров передаются сгенерированный 24-байтный ключ (`SecretKeySpec`) и 8-байтный вектор инициализации (`IvParameterSpec`).
    -   Вызывается `cipher.doFinal()` для выполнения операции.

4.  **Кодирование в Base64:**
    -   Зашифрованный массив байт кодируется в строку с помощью `android.util.Base64`.
    -   Используется флаг `Base64.DEFAULT`, который добавляет переносы строк, что обеспечивает совместимость с методом `Convert.ToBase64String` из C#.
    -   При дешифровке используется тот же флаг, чтобы корректно обработать строку Base64 с переносами строк.

## 4. Интеграция в приложении

-   **`LoginActivity.login()`:**
    -   Если у `UserConfig` установлен флаг `isEncrypted`, `LoginActivity` вызывает `CryptoUtils.decrypt()`, передавая в него зашифрованный пароль из профиля и пароль, введенный пользователем в UI (который используется как ключ).
-   **`ProfileActivity` (при сохранении):**
    -   Если пользователь выбрал шифрование профиля, `ProfileActivity` вызывает `CryptoUtils.encrypt()`, передавая в него пароль от аккаунта и пароль шифрования (ключ).
    -   Полученная строка Base64 сохраняется в поле `UserConfig.UserPassword`, а флаг `isEncrypted` устанавливается в `true`.
