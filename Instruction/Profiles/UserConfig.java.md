# Анализ и архитектура `UserConfig.java`

**Файл:** `app/src/main/java/ru/neverlands/abclient/model/UserConfig.java`

## 1. Назначение

`UserConfig` — это центральный класс-модель, который представляет собой полный профиль пользователя. Он содержит всю информацию, необходимую для авторизации, настроек прокси, списка контактов и конфигурации различных элементов интерфейса. Класс спроектирован с публичными полями для максимальной совместимости с портированным кодом, который ожидает прямой доступ к этим данным.

## 2. Структура данных (Модель)

Все ключевые данные хранятся в виде публичных полей класса.

-   **Учетные данные:**
    -   `public String UserNick`: Ник пользователя.
    -   `public String UserPassword`: Пароль. Если `isEncrypted` равно `true`, это поле содержит зашифрованную строку.
    -   `public boolean isEncrypted`: Флаг, указывающий, зашифрован ли пароль.
    -   `public long LastLogin`: Временная метка последнего входа, используется для выбора профиля по умолчанию.

-   **Настройки прокси:**
    -   `public boolean UseProxy`: Включено ли использование прокси.
    -   `public String ProxyAddress`, `ProxyUserName`, `ProxyPassword`: Параметры для подключения к прокси.

-   **Контакты:**
    -   `public SortedMap<String, Contact> contacts`: Отсортированная карта, хранящая контакты пользователя. Ключ — ник в нижнем регистре.

-   **Настройки UI (`doShow...`):**
    -   Большой набор булевых флагов (например, `doShowFastAttack`, `doShowFastAttackBlood`), которые контролируют видимость кнопок быстрых действий в игровом интерфейсе. Эти флаги напрямую используются в `WebAppInterface`.

## 3. Механизм хранения (XML)

Профили пользователей сохраняются в файловой системе в формате **XML**.

-   **Расположение:** Внешняя директория приложения, доступная через `context.getExternalFilesDir("profiles")`. Это сделано для того, чтобы профили не удалялись при переустановке приложения.
-   **Имя файла:** `{UserNick}.profile` (например, `Блудя.profile`).

### Сохранение (`save`)
-   **Триггер:** Метод `save(Context context)` вызывается из `LoginActivity` после успешного входа или из `ProfileActivity` при сохранении изменений.
-   **Процесс:**
    1.  Создается `FileOutputStream` для файла `{UserNick}.profile`.
    2.  Используется `org.xmlpull.v1.XmlSerializer` для записи данных.
    3.  Все публичные поля класса (`UserNick`, `UserPassword`, `isEncrypted`, контакты, флаги `doShow...`) сериализуются в XML-теги и их атрибуты.
    -   **Пример XML-структуры:**
        ```xml
        <profile>
            <user name="Блудя" password="..." isEncrypted="false" />
            <contacts>
                <contactentry name="Друг1" classid="1" />
            </contacts>
            <fastactions simple="false" blood="true" ... />
        </profile>
        ```

### Загрузка (`loadAllProfiles` и `load`)
-   **Триггер:** `UserConfig.loadAllProfiles(Context context)` вызывается из `LoginActivity` при инициализации экрана.
-   **Процесс:**
    1.  Метод сканирует директорию `profiles` на наличие файлов с расширением `.profile`.
    2.  Для каждого найденного файла создается новый экземпляр `UserConfig`.
    3.  Вызывается внутренний метод `load(File profileFile)`.
    4.  `load` использует `org.xmlpull.v1.XmlPullParser` для чтения XML-файла и последовательного заполнения публичных полей объекта `UserConfig` данными из атрибутов тегов.

## 4. Шифрование

-   **Механизм:** Если флаг `isEncrypted` установлен в `true`, поле `UserPassword` хранит не сам пароль, а его зашифрованную версию.
-   **Зависимость:** Для шифрования и дешифровки используется класс `ru.neverlands.abclient.utils.CryptoUtils`.
-   **Процесс в `LoginActivity`:**
    1.  Если `selectedProfile.isEncrypted` равно `true`, текст из поля ввода пароля используется как ключ для дешифровки.
    2.  Вызывается `CryptoUtils.decrypt(profileToLogin.UserPassword, passwordOrKey)`.
    3.  Если дешифровка не удалась (неверный ключ), пользователю показывается ошибка. Если удалась, полученный пароль используется для авторизации через `AuthManager`.
