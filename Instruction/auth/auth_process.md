# Полное описание процесса авторизации

Этот документ описывает полный процесс авторизации в приложении, начиная от ввода данных пользователем и заканчивая загрузкой основного экрана игры.

## 1. Ввод данных и запуск авторизации

Процесс начинается в `LoginActivity`.

1.  **Пользовательский ввод**: Пользователь вводит свои `имя пользователя` и `пароль` в соответствующие поля и нажимает кнопку "Войти".
2.  **Вызов `login()`**: Нажатие кнопки вызывает метод `login()` в `LoginActivity`.
3.  **Вызов `AuthManager.authorize()`**: Метод `login()` собирает введенные данные и вызывает статический метод `AuthManager.authorize()`.

## 2. Процесс авторизации в `AuthManager`

`AuthManager` отвечает за выполнение HTTP-запросов для аутентификации пользователя. Он использует `OkHttpClient` для выполнения запросов и `WebViewCookieJar` для управления cookie.

Процесс состоит из трех шагов:

1.  **Шаг 1: Получение αρχικών cookie**
    *   **Функция**: `AuthManager.authorize()`
    *   **Действие**: Отправляется GET-запрос на `http://neverlands.ru/`.
    *   **Цель**: Получить αρχльные cookie сессии от сервера.

2.  **Шаг 2: Отправка данных для входа**
    *   **Функция**: `AuthManager.authorize()`
    *   **Действие**: Отправляется POST-запрос на `http://neverlands.ru/game.php` с `именем пользователя` и `паролем` в теле запроса.
    *   **Цель**: Аутентифицировать пользователя на сервере.

3.  **Шаг 3: Проверка авторизации**
    *   **Функция**: `AuthManager.authorize()`
    *   **Действие**: Отправляется GET-запрос на `http://neverlands.ru/main.php`.
    *   **Цель**: Проверить, что авторизация прошла успешно. Сервер должен вернуть основную страницу игры, а не форму входа.

### Управление Cookie

*   **Класс**: `WebViewCookieJar`
*   **Описание**: Этот класс реализует интерфейс `CookieJar` из `OkHttp`. Он использует стандартный `CookieManager` Android для сохранения и загрузки cookie. Это обеспечивает совместное использование cookie между `OkHttpClient` (используемым в `AuthManager`) и `WebView` (используемым в `MainActivity`).

## 3. Завершение авторизации и запуск основного экрана

1.  **Обратный вызов `onSuccess()`**: Если все три шага в `AuthManager` проходят успешно, вызывается колбэк `onSuccess()`.
2.  **Запуск `MainActivity`**: В `LoginActivity` реализация `onSuccess()` создает `Intent` для запуска `MainActivity` и закрывает `LoginActivity`.

## 4. Загрузка основного экрана игры

1.  **Запуск `ProxyService`**: В методе `onCreate()` `MainActivity` запускается `ProxyService` вызовом `((ABClientApplication) getApplication()).startProxyService()`.
2.  **Настройка прокси для `WebView`**: Метод `setupProxy()` в `MainActivity` устанавливает системные свойства `http.proxyHost` и `http.proxyPort`, чтобы `WebView` использовал локальный прокси-сервер, запущенный в `ProxyService`.
3.  **Загрузка URL**: `MainActivity` загружает URL `http://neverlands.ru/main.php` в `WebView`.
4.  **Обработка запроса прокси-сервером**:
    *   `WebView` делает запрос через прокси-сервер.
    *   `ProxyService` принимает соединение и создает `SessionHandler` для обработки запроса.
    *   `SessionHandler` использует `CookiesManager` для получения сохраненных cookie и добавляет их в заголовок запроса.
5.  **Отображение страницы**: Сервер получает запрос с правильными cookie и возвращает основную страницу игры, которая отображается в `WebView`.

## Важные классы и их роли

*   **`LoginActivity`**: Экран входа, собирает данные пользователя.
*   **`AuthManager`**: Выполняет HTTP-запросы для аутентификации.
*   **`WebViewCookieJar`**: Управляет cookie, обеспечивая их совместное использование.
*   **`MainActivity`**: Основной экран, отображает игру в `WebView`.
*   **`ProxyService`**: Локальный прокси-сервер для перехвата и обработки запросов.
*   **`SessionHandler`**: Обрабатывает отдельные сессии прокси-сервера.
*   **`CookiesManager`**: Управляет хранилищем cookie на устройстве.
