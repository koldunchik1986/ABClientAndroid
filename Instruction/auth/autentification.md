# Документация по процессу авторизации в ABClient

## Введение

Этот документ описывает полный пошаговый процесс авторизации пользователя в приложении ABClient. Цель — получить от сервера `neverlands.ru` валидные сессионные cookies и успешно загрузить игровой интерфейс в `WebView`.

## Основные компоненты

Процесс авторизации затрагивает несколько ключевых классов:

1.  **`LoginActivity.java`**: Пользовательский интерфейс для ввода логина и пароля. Является точкой входа для процесса авторизации.
2.  **`AuthManager.java`**: Основной класс, который управляет всем процессом. Он выполняет сетевые запросы, обрабатывает ответы и управляет cookies.
3.  **`WebViewCookieJar.java`**: Вспомогательный класс, который служит мостом между хранилищем cookies библиотеки `OkHttp` и системным `CookieManager` Android. Это позволяет `WebView` использовать cookies, полученные через `OkHttp`.
4.  **`MainActivity.java`**: Главная активность, которая содержит `WebView` для отображения игрового интерфейса. Она использует сессию, установленную `AuthManager`.

## Пошаговый процесс авторизации

Процесс состоит из нескольких критически важных шагов:

### 1. Инициация в `LoginActivity`

-   Пользователь вводит пароль и нажимает кнопку "Вход".
-   Вызывается метод `login()`, который собирает данные (имя пользователя из выбранного профиля и введенный пароль).
-   Вызывается главный метод `AuthManager.authorize(context, username, password, callback)`.

### 2. Очистка старой сессии

-   В самом начале `AuthManager.authorize()` происходит полная очистка всех cookies из системного `CookieManager`:
    ```java
    android.webkit.CookieManager.getInstance().removeAllCookies(null);
    android.webkit.CookieManager.getInstance().flush();
    ```
-   Это гарантирует, что мы начинаем авторизацию с чистого листа, без старых или невалидных сессий.

### 3. Шаг 1: GET-запрос для получения `watermark`

-   `AuthManager` с помощью библиотеки `OkHttp` отправляет GET-запрос на главную страницу `http://neverlands.ru/`.
-   **Цель:** Сервер в ответ устанавливает первичный cookie `watermark`. Этот cookie, по-видимому, необходим для последующего POST-запроса авторизации.

### 4. Шаг 2: POST-запрос с данными для входа

-   После успешного получения `watermark`, `AuthManager` отправляет POST-запрос на `http://neverlands.ru/game.php`.
-   В теле запроса передаются `player_nick` (имя пользователя) и `player_password` (пароль) в кодировке `windows-1251`.
-   **Цель:** В случае успешной валидации данных, сервер в ответ присылает заголовки `Set-Cookie`, которые содержат все необходимые сессионные cookies (`PHPSESSID`, `NeverPuid`, `NeverCode`, `NeverHash` и т.д.).

### 5. Сохранение и синхронизация Cookies

-   Благодаря `WebViewCookieJar`, все cookies, полученные `OkHttp`, автоматически сохраняются в системный `CookieManager`.
-   После получения успешного ответа от `game.php`, `AuthManager` выполняет критически важную команду:
    ```java
    CookieManager.getInstance().flush();
    ```
-   **`flush()`**: Этот вызов принудительно записывает все cookies из оперативной памяти в постоянное хранилище. **Без этого вызова `WebView` может не "увидеть" новую сессию**, что приводило к проблеме с экраном "Cookie...".

### 6. Запуск `MainActivity`

-   `AuthManager` вызывает колбэк `onSuccess()`.
-   `LoginActivity` в этом колбэке создает `Intent` для `MainActivity`, запускает ее и закрывает себя.
-   `MainActivity` загружает URL `http://neverlands.ru/main.php`. `WebView` автоматически подхватывает сохраненные в `CookieManager` сессионные cookies, и сервер отдает полноценный игровой интерфейс.

## Ключевые переменные и функции

-   `AuthManager.authorize()`: Основной метод, запускающий всю цепочку авторизации.
-   `WebViewCookieJar`: Ключевой элемент, обеспечивающий синхронизацию cookies между `OkHttp` и `WebView`.
-   `CookieManager.getInstance().flush()`: **Критически важный вызов**, решающий проблему "потерянной" сессии.
-   `MainActivity.shouldInterceptRequest()`: Метод, который перехватывает запросы `WebView`. В контексте авторизации он важен тем, что обеспечивает передачу cookies для всех последующих подзапросов (загрузка картинок, скриптов и т.д.).

## Зависимости

-   **`com.squareup.okhttp3:okhttp`**: Библиотека для выполнения HTTP-запросов. Используется в `AuthManager`.
-   **Android `CookieManager`**: Системный класс для управления cookies в `WebView`.

## Возможные проблемы и их решения

1.  **Проблема:** После входа отображается экран "Cookie..." или похожая ошибка.
    -   **Причина:** Сессия "потерялась" между `AuthManager` и `WebView`.
    -   **Решение:** Убедиться, что `CookieManager.getInstance().flush()` вызывается после успешного получения cookies и перед запуском `MainActivity`.

2.  **Проблема:** После входа отображается сырой HTML-код страницы.
    -   **Причина:** `WebView` получил данные с неверным MIME-типом (например, `text/plain` вместо `text/html`).
    -   **Решение:** В `shouldInterceptRequest` при создании `WebResourceResponse` для `main.php` необходимо принудительно установить правильный MIME-тип: `new WebResourceResponse("text/html", "windows-1251", ...)`. 

3.  **Проблема:** Ошибка "неверный логин или пароль".
    -   **Причина:** Сервер после POST-запроса вернул страницу, содержащую форму авторизации (`auth_form`).
    -   **Решение:** `AuthManager` уже содержит проверку на наличие `auth_form` в теле ответа и корректно обрабатывает эту ошибку.
