# Инструкция по работе кнопок навигации

## Общее описание

Кнопки навигации в игре (например, "Инвентарь", "Выйти") реализованы с помощью JavaScript функции `ButClick(id)`, которая вызывается при нажатии на соответствующую кнопку. Эта функция формирует URL для перехода и осуществляет переход в фрейме `main`.

## Ключевые файлы и переменные

*   **`castle_v05.js`**: Основной файл, содержащий логику работы кнопок в комнате Кланового Замка.
*   **`HtmlLog_Main_*.txt`**: Снимок HTML-кода основного фрейма, в котором инициализируются переменные для работы кнопок.
*   **`ChListJs.java`**: Java-класс, который модифицирует `ch_list.js`.
*   **`CastleJs.java`**: Java-класс, который модифицирует `castle_v05.js`.

### Переменные в HTML

В HTML-коде основного фрейма инициализируются следующие ключевые переменные:

*   `mapbt`: Массив, содержащий информацию о кнопках. Каждый элемент массива представляет собой кнопку и содержит:
    *   `id`: Идентификатор кнопки (например, `inf`, `inv`, `up`).
    *   `Название`: Текст кнопки.
    *   `vcode`: Уникальный код для формирования URL.
    *   `[]`: Пустой массив (не используется).

    **Пример:**
    ```javascript
    var mapbt = [["inf","Ваш персонаж","99e727b76fb80ecc8bd9b2fdd72916ea",[]],["inv","Инвентарь","5b5ae3b970c4da3dd2afe4ee4cc4ec74",[]],["up","Выйти","e33b8852aff8c729a6c22c10ee8bab18",[]]];
    ```

*   `bavail`: Ассоциативный массив, который формируется из `mapbt` в функции `ButtonGen()` и используется в `ButClick(id)` для получения `vcode`.

### Функция `ButClick(id)`

Эта функция вызывается при нажатии на кнопку. Она выполняет следующие действия:

1.  Принимает `id` кнопки в качестве аргумента.
2.  Формирует URL для перехода, используя `id` и `vcode` из массива `bavail`.
3.  Осуществляет переход по сформированному URL в фрейме `main` с помощью `window.open(goloc, 'main')`.

**Пример:**
```javascript
function ButClick(id)
{
    var goloc = '';
    switch(id)
    {
        case 'inf': goloc = 'main.php?get_id=56&act=10&go=inf&vcode='+bavail[id][0]; break;
        case 'inv': goloc = 'main.php?get_id=56&act=10&go=inv&vcode='+bavail[id][0]; break;
        case 'up': goloc = 'main.php?get_id=56&act=10&go=up&vcode='+bavail[id][0]; break;
    }
    if(goloc)
    {
        for(var j=0; j<bavail[id][1].length; j++) goloc += '&'+bavail[id][1][j][0]+'='+bavail[id][1][j][1];
        window.open(goloc, 'main');
    }
}
```

## Процесс работы

1.  При загрузке основного фрейма инициализируются переменные `mapbt` и `bavail`.
2.  При нажатии на кнопку вызывается функция `ButClick(id)`.
3.  `ButClick(id)` формирует URL и открывает его в фрейме `main`.

## Патчи

Для корректной работы кнопок в Android-приложении были применены следующие патчи:

*   **`ChListJs.java`**: Исправлена синтаксическая ошибка в формировании HTML-кода.
*   **`CastleJs.java`**: `document.location = goloc;` заменен на `window.open(goloc, 'main');` для предотвращения перезагрузки всей страницы.

## Взаимодействие с кэшем и `shouldInterceptRequest` (Важно!)

После внедрения системы кэширования (`abcache`) возникла проблема: навигационные кнопки перестали работать, вызывая лишь обновление страницы. Это связано с тем, как `WebView` обрабатывает перехваченные запросы.

### Описание проблемы

1.  Все запросы из `WebView` перехватываются методом `shouldInterceptRequest` в `MainActivity.java` для реализации кэширования.
2.  Когда `ButClick` вызывает `window.open(url, 'main')`, этот запрос также перехватывается.
3.  Если `shouldInterceptRequest` **обрабатывает** этот навигационный запрос и возвращает `WebResourceResponse` (даже из кэша), `WebView` просто загружает полученные данные в текущий (верхний) фрейм. При этом указание `target='main'` **игнорируется**.

### Решение

Чтобы `WebView` корректно обработал `target='main'`, необходимо **отказаться от перехвата** именно этих навигационных запросов. `shouldInterceptRequest` должен вернуть `null`, чтобы позволить `WebView` обработать запрос нативно, как это делает обычный браузер.

Это достигается добавлением проверки в самое начало метода:

```java
// Фрагмент из MainActivity.java
@Override
public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
    final String url = request.getUrl().toString();

    // Если это навигационный запрос от ButClick, не перехватывать его.
    // WebView сам обработает его и корректно загрузит в target='main'.
    if (url.contains("main.php?get_id=")) {
        return null; 
    }

    // ... остальная логика перехвата для кэширования ...
}
```
