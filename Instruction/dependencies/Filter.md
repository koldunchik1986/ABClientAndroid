# Инструкция: Пост-фильтрация ответов (Filter)

## 1. Назначение

Класс `Filter` является центральным диспетчером для модификации сетевых ответов. Его основная задача — принять "сырые" данные (в виде массива байт), полученные от сервера, и применить к ним ряд специфических фильтров в зависимости от URL-адреса запроса. 

Это позволяет "на лету" изменять HTML-страницы и JavaScript-файлы перед тем, как они будут переданы в `WebView` для отображения. Таким образом реализуется большая часть кастомной логики клиента, включая:
-   Отключение рекламы и счетчиков.
-   Внедрение собственных скриптов для автоматизации.
-   Исправление багов верстки оригинального сайта.
-   Извлечение данных из страниц для их использования в нативном коде.

## 2. Основной метод: `process`

**Сигнатура:** `public static byte[] process(String address, byte[] array)`

Это единственный публичный метод, который вызывается из `WebViewClient.shouldInterceptRequest`.

**Алгоритм работы:**
1.  Метод принимает URL (`address`) и данные (`array`).
2.  Далее следует большая цепочка `if-else if` конструкций, которая работает как маршрутизатор.
3.  Для каждого типа URL, требующего обработки, вызывается соответствующий статический метод из другого класса (например, `HpJs.process(array)` или `MainPhp.process(address, array)`).
4.  Каждый из этих классов-обработчиков (`HpJs`, `MainPhp` и т.д.) содержит специфическую логику для конкретной страницы или скрипта.
5.  Если ни одно из условий не сработало, метод возвращает исходный массив байт `array` без изменений.

**Пример:**
```java
// ...
if (address.endsWith("/js/hp.js")) {
    return HpJs.process(array);
}
// ...
if (address.startsWith("http://www.neverlands.ru/main.php")) {
    return MainPhp.process(address, array);
}
// ...
return array; // Вернуть без изменений
```

## 3. Вспомогательные методы

-   **`buildRedirect(String description, String link)`**: Создает простую HTML-страницу с JavaScript-редиректом. Используется для перенаправления пользователя.
-   **`removeDoctype(String html)` / `removeDoctype(byte[] array)`**: Удаляет объявление `<!DOCTYPE ...>` из HTML-кода. Это может быть необходимо для исправления некоторых проблем с рендерингом в `WebView`.

## 4. Зависимости

Класс `Filter` является центральным узлом, который зависит от множества других классов-фильтров. Каждый из этих классов находится в пакете `ru.neverlands.abclient.postfilter` и отвечает за свой конкретный участок работы:

-   `CounterJs`: Обработка скриптов счетчиков (liveinternet, top.mail.ru).
-   `HpJs`: Модификация скрипта, отвечающего за отображение здоровья.
-   `MapJs`, `MapAjax`, `MapActAjaxPhp`: Фильтры, связанные с картой мира.
-   `GameJs`, `GamePhp`: Фильтры для основных игровых скриптов и страниц.
-   `MainPhp`: Один из самых крупных фильтров, обрабатывающий главную страницу игры.
-   `Pinfo`, `PinfoJs`, `NlPinfoJs`, `PinfonewJs`: Набор фильтров для разных версий страницы информации о персонаже.
-   И многие другие (`ArenaJs`, `FightJs`, `ShopJs`, `ChMsgJs` и т.д.).

Каждый из этих классов инкапсулирует свою узкоспециализированную логику, что делает класс `Filter` относительно простым и понятным, несмотря на большое количество условий.
