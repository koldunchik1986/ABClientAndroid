# Инструкция: Мост JavaScript-Java (WebAppInterface)

## 1. Назначение

Класс `WebAppInterface` является "мостом" между кодом JavaScript, исполняемым внутри `WebView`, и нативным кодом приложения на Java. Он позволяет вызывать Java-методы напрямую из JS, что является ключевым механизмом для двустороннего взаимодействия.

Без этого моста `WebView` был бы просто изолированным браузером. С его помощью веб-страницы могут запрашивать у приложения данные, сообщать о событиях и вызывать нативные функции (например, показ диалоговых окон).

## 2. Принцип работы

#### 2.1. Регистрация моста

В `MainActivity.setupWebView()` экземпляр этого класса привязывается к `WebView`:

```java
webView.addJavascriptInterface(new WebAppInterface(this), "AndroidBridge");
```
-   `new WebAppInterface(this)`: Создается новый объект моста.
-   `"AndroidBridge"`: Это имя, под которым данный Java-объект будет доступен в глобальной области видимости JavaScript внутри `WebView`.

#### 2.2. Вызов из JavaScript

После регистрации любой публичный метод класса `WebAppInterface`, помеченный аннотацией `@JavascriptInterface`, становится доступен для вызова из JS:

```javascript
// Пример вызова из JS-кода на странице
if (window.AndroidBridge) {
    AndroidBridge.showToast("Привет из JavaScript!");
}
```

## 3. Ключевые методы

Ниже описаны некоторые важные методы, предоставляемые этим мостом.

#### `public void showToast(String toast)`
-   **Назначение:** Демонстрационный метод, который показывает нативное Android-сообщение (`Toast`) с текстом, переданным из JS.

#### `public int GetClassIdOfContact(String name)`
-   **Назначение:** Позволяет скрипту чата (`ch_list.js`) узнать статус контакта (враг, друг, нейтрал) по его нику.
-   **Алгоритм:**
    1.  JS на странице чата вызывает `AndroidBridge.GetClassIdOfContact("имя_персонажа")`.
    2.  Этот метод, в свою очередь, обращается к `ContactsManager.getClassIdOfContact(name)`.
    3.  `ContactsManager` (в текущей реализации) возвращает `0` как заглушку, но в будущем здесь будет логика проверки по базе данных контактов.
    4.  Возвращенное число используется в JS для определения цвета ника в списке чата.

#### `public String CheckFastAttack(String login, String wmlabFA)` и аналогичные
-   **Назначение:** Эти методы позволяют нативному коду контролировать отображение кнопок быстрых действий (атаки, магия и т.д.) в `WebView`.
-   **Алгоритм:**
    1.  JS на странице вызывает, например, `AndroidBridge.CheckFastAttack("имя_цели", "<html_код_кнопки>")`.
    2.  Java-метод проверяет настройки в `AppVars.Profile.doShowFastAttack`.
    3.  Если настройка включена, метод возвращает переданный ему HTML-код кнопки, и JS вставляет его на страницу.
    4.  Если настройка выключена, метод возвращает пустую строку, и кнопка не отображается.

#### `public String InfoToolTip(String name, String alt)`
-   **Назначение:** Используется для кастомизации всплывающих подсказок.
-   **В данный момент** просто возвращает переданный текст без изменений, но является точкой для будущих модификаций.

## 4. Важное замечание

Все методы, помеченные `@JavascriptInterface`, выполняются в специальном фоновом потоке. Если из них необходимо выполнить какие-либо действия с UI (например, показать `Toast` или `AlertDialog`), их нужно оборачивать в `runOnUiThread()`:

```java
@JavascriptInterface
public void someMethod() {
    runOnUiThread(new Runnable() {
        @Override
        public void run() {
            // Код, который должен выполняться в UI-потоке
            Toast.makeText(mContext, "Hello from UI thread!", Toast.LENGTH_SHORT).show();
        }
    });
}
```
