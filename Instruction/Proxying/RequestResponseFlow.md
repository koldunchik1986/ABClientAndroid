# Анализ обработки запросов и ответов

**Основной файл:** `app/src/main/java/ru/neverlands/abclient/MainActivity.java` (внутренний класс `CustomWebViewClient`)

## 1. Общая схема

Весь сетевой трафик `WebView` перехватывается и обрабатывается методом `shouldInterceptRequest`. Этот метод действует как центральный узел, который получает оригинальный запрос от `WebView`, выполняет его самостоятельно, модифицирует полученный ответ и возвращает его обратно в `WebView`. Ключевой особенностью является работа с кодировкой `windows-1251`.

## 2. Жизненный цикл исходящего запроса

1.  **Перехват:** `WebView` инициирует запрос (например, на `http://neverlands.ru/main.php`). `shouldInterceptRequest` получает объект `WebResourceRequest`.
2.  **Создание нового запроса:** Создается новый экземпляр `java.net.HttpURLConnection` с URL из оригинального запроса.
3.  **Копирование заголовков:** Все заголовки из `request.getRequestHeaders()` копируются в `HttpURLConnection`. Это важно для сохранения таких параметров, как `User-Agent`, `Accept`, `Referer` и т.д.
4.  **Внедрение Cookies:** Вызывается `CookiesManager.obtain(url)`, который возвращает строку с актуальными сессионными cookies из системного `CookieManager`. Эта строка устанавливается в заголовок `Cookie`.
5.  **Выполнение:** Запрос отправляется на сервер.

## 3. Жизненный цикл входящего ответа

1.  **Чтение сырых данных:** Ответ от сервера читается из `connection.getInputStream()` в виде массива байт (`byte[] data`). На этом этапе данные могут быть сжаты (GZIP) и находятся в кодировке, указанной сервером.

2.  **Декомпрессия (GZIP):**
    -   Проверяется заголовок ответа `Content-Encoding`.
    -   Если он равен `gzip`, массив `data` распаковывается с помощью `GZIPInputStream`.
    -   После распаковки переменная `encoding` обнуляется, так как сжатие уже снято.

3.  **Декодирование в строку (для модификации):**
    -   **Ключевой шаг:** Для того чтобы работать с HTML или JS как с текстом, массив байт `data` необходимо преобразовать в `String`.
    -   **Кодировка:** На этом этапе **предполагается**, что сервер всегда отвечает в `windows-1251`. Поэтому для корректного преобразования используется:
        ```java
        String html = new String(data, "windows-1251");
        ```

4.  **Модификация строки:**
    -   **Извлечение данных:** Распарсенная строка `html` используется для поиска и извлечения данных, например, массива `ChatListU` из `ch.php` с помощью регулярных выражений.
    -   **Фильтрация:** Строка `html` передается в цепочку фильтров `Filter.process(url, ...)` где происходят различные замены и добавления.
    -   **Инъекция JS:** В HTML-страницы добавляются JS-заглушки для предотвращения ошибок (`injectJsFix`).

5.  **Кодирование обратно в байты:**
    -   После всех текстовых модификаций, измененная строка `String newHtml` кодируется обратно в массив байт.
    -   **Кодировка:** Для сохранения целостности данных используется та же кодировка:
        ```java
        byte[] processedData = newHtml.getBytes("windows-1251");
        ```

6.  **Формирование `WebResourceResponse`:**
    -   Создается финальный ответ для `WebView`.
    -   `new WebResourceResponse(mimeType, "windows-1251", new ByteArrayInputStream(processedData));`
    -   **Важный момент:** В качестве кодировки (`encoding`) здесь жестко указана `windows-1251`. Это говорит `WebView`, как именно интерпретировать байты из `processedData`. Если бы здесь была указана, например, `UTF-8`, а байты были в `windows-1251`, это привело бы к некорректному отображению символов (кракозябрам).

## 4. Выводы

-   Приложение строго рассчитано на работу с кодировкой **`windows-1251`** на всех этапах: от отправки данных формы (`AuthManager`) до обработки и возврата ответов в `WebView`.
-   Любая ошибка в указании правильной кодировки на любом из этапов декодирования/кодирования приведет либо к невозможности распарсить ответ, либо к некорректному отображению контента.
-   Проблема "сырого HTML", которую мы наблюдали, скорее всего, была вызвана тем, что в `WebResourceResponse` в качестве `mimeType` передавался `text/plain` вместо `text/html`, либо была нарушена кодировка, из-за чего `WebView` не смог распознать структуру документа.
