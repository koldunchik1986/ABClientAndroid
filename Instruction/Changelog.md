# Changelog v.1.0.1

Это первая версия приложения, и этот документ описывает основной функционал, реализованный на данный момент.

## Общая архитектура

Приложение представляет собой Android-клиент для браузерной игры Neverlands. Оно состоит из следующих основных компонентов:

*   **Аутентификация**: Механизм для входа пользователя в игру.
*   **Основной экран**: Отображение игрового процесса в `WebView`.
*   **Прокси-сервер**: Локальный прокси для перехвата и модификации трафика.
*   **Настройки**: Экран для конфигурации приложения.
*   **Управление данными**: Сохранение и загрузка настроек и других данных.
*   **Фильтрация ответов**: Модификация HTML и JS ответов от сервера.

## 1. Аутентификация

Аутентификация является ключевым компонентом для доступа к игре.

*   **`LoginActivity.java`**: Пользовательский интерфейс для ввода логина и пароля.
    *   `login()`: Метод, который запускает процесс аутентификации.
*   **`AuthManager.java`**: Отвечает за логику аутентификации.
    *   `authorize(Context context, String username, String password, AuthCallback callback)`: Статический метод, выполняющий 3-шаговую аутентификацию:
        1.  GET-запрос для получения сессионных cookie.
        2.  POST-запрос с логином и паролем.
        3.  GET-запрос для проверки успешной аутентификации.
*   **`WebViewCookieJar.java`**: Реализация `okhttp3.CookieJar`, которая синхронизирует cookie между `OkHttpClient` и `WebView`.

## 2. Основной экран

Основной экран отображает игру и предоставляет основной интерфейс пользователя.

*   **`MainActivity.java`**: Основная Activity приложения.
    *   `onCreate(Bundle savedInstanceState)`: Инициализирует `WebView`, `Toolbar`, боковое меню и запускает `ProxyService`.
    *   `setupProxy()`: Настраивает `WebView` для использования локального прокси-сервера.
    *   `WebView`: Основной компонент для отображения игрового контента.

## 3. Прокси-сервер

Локальный прокси-сервер является ядром приложения, позволяя перехватывать и изменять трафик между клиентом и сервером.

*   **`ProxyService.java`**: `Service`, который запускает и останавливает прокси-сервер.
    *   `onStartCommand(...)`: Запускает прокси-сервер в отдельном потоке.
    *   `startProxyServer()`: Создает `ServerSocket` и слушает входящие соединения.
    *   `getUpstreamProxy()`: Возвращает внешний прокси, если он настроен в профиле.
*   **`SessionHandler.java`**: Обрабатывает каждое клиентское соединение в отдельном потоке.
    *   Читает запрос от клиента, отправляет его на сервер, получает ответ и отправляет его обратно клиенту.
    *   Применяет фильтры к ответам сервера.
*   **`CookiesManager.java`**: Управляет хранилищем cookie.
    *   `assign(String host, String cookieHeader)`: Сохраняет cookie из заголовка `Set-Cookie`.
    *   `obtain(String host)`: Возвращает cookie для указанного хоста.

## 4. Настройки

Экран настроек позволяет пользователю изменять различные параметры приложения.

*   **`SettingsActivity.java`**: Activity, которая отображает фрагмент с настройками.
*   **`SettingsFragment.java`**: `PreferenceFragmentCompat`, который загружает настройки из `res/xml/root_preferences.xml`.
*   **`UserConfig.java`**: Класс, представляющий конфигурацию пользователя.
    *   `load(Context context)`: Загружает конфигурацию из `SharedPreferences`.
    *   `save(Context context)`: Сохраняет конфигурацию в `SharedPreferences`.
    *   Содержит поля для всех настроек, таких как `UserNick`, `UserPassword`, `DoProxy`, `ProxyAddress` и т.д.

## 5. Управление данными

*   **`DataManager.java`**: Отвечает за операции с файлами.
    *   `init(Context context)`: Инициализирует менеджер данных, создает необходимые директории и копирует `assets`.
    *   `readFileToString(String fileName)`: Читает файл в строку.
    *   `writeStringToFile(String fileName, String content)`: Записывает строку в файл.

## 6. Фильтрация ответов

*   **`Filter.java`**: Класс, который изменяет ответы сервера перед их отображением в `WebView`.
    *   `process(String address, byte[] array)`: Основной метод, который вызывает другие методы для обработки в зависимости от URL.
    *   Содержит методы для обработки различных JS-файлов и HTML-страниц, например, `processHpJs`, `processMapJs`, `processMainPhp` и т.д. (в данный момент большинство из них являются заглушками).
