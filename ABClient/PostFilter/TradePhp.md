# Анализ TradePhp.cs

Файл `TradePhp.cs` является частью `PostFilter` и представляет собой ядро автоматического скупщика вещей. Он активируется, когда другой игрок инициирует сделку с персонажем.

## Зависимости

Этот модуль критически зависит от вспомогательного класса `TorgList.cs`, который отвечает за парсинг "торговой таблицы" из настроек и вычисление приемлемой цены для покупки.

## Функциональность

1.  **Парсинг сделки**: Из HTML-кода страницы `trade.php` извлекается вся информация о предлагаемой вещи:
    *   Ник продавца.
    *   Название вещи и ее уровень.
    *   Текущая и максимальная долговечность.
    *   Государственная цена.
    *   Цена, запрашиваемая продавцом.

2.  **Оценка и принятие решений**: Скрипт автоматически принимает решение о покупке, основываясь на наборе правил:
    *   **Авто-отказ (слишком дорого)**: Если цена продавца выше, чем расчетная цена из `TorgList`, сделка отклоняется.
    *   **Авто-отказ (слишком дешево)**: Если цена продавца подозрительно низкая (ниже 90% от госцены), сделка отклоняется для предотвращения покупки "мусора".
    *   **Авто-отказ (черный список)**: Если название вещи содержит ключевые слова из списка запрещенных в настройках (`TorgDeny`), сделка отклоняется.
    *   **Авто-покупка**: Если все проверки пройдены, скрипт генерирует редирект для подтверждения покупки.

3.  **Логика после покупки ("Авто-слив")**:
    *   Если в настройках включена опция `TorgSliv`, скрипт решает, нужно ли немедленно продать купленную вещь в государственный магазин.
    *   Решение принимается на основе уровня вещи и наличия ключевых слов в названии (список исключений `TorgEx`).
    *   Если решено продать, устанавливается флаг `TorgList.TriggerBuy = true`, который обрабатывается в `MainPhp.cs`.

4.  **Подготовка сообщений для чата**: Скрипт использует `TorgList.DoFilter` для генерации сообщений продавцу (об отказе, благодарности, нехватке денег), которые будут отправлены в чат после завершения сделки.

## План портирования в Java

1.  **Портировать `TorgList.cs`**: Создать `TorgPair.java` и `TorgList.java` в пакете `ru.neverlands.abclient.manager`. (Уже сделано).
2.  **Создать `TradePhp.java`**: В пакете `ru.neverlands.abclient.postfilter`.
3.  **Реализовать метод `process`**:
    *   Перенести всю логику парсинга HTML, используя `String.indexOf` и `String.substring` (аналогично `HelperStrings.SubString`).
    *   Использовать `TorgList.calculate` для оценки цены.
    *   Заменить вызовы `AppVars.MainForm.BeginInvoke` на отправку событий в UI-поток (например, через `Handler` или `LocalBroadcastManager`).
    *   Заменить вызовы `Chat.AddAnswer` на вызовы соответствующего менеджера чата в Android-версии.
    *   Использовать `buildRedirect` для генерации редиректов.
4.  **Интегрировать в `Filter.java`**: В `Filter.java` найти условие `address.startsWith("http://www.neverlands.ru/gameplay/trade.php")` и вызывать из него `TradePhp.process(array)`.
