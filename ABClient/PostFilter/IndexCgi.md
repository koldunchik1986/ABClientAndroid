# Анализ IndexCgi.cs

Файл `IndexCgi.cs` является частью `PostFilter` и предназначен для обработки главной страницы входа в игру (`index.cgi` или `www.neverlands.ru/`). Его ключевая задача — автоматизация процесса авторизации.

## Функциональность

1.  **Проверка на страницу авторизации**:
    *   Фильтр сначала ищет в HTML-коде форму с `id="auth_form"`. Если такая форма не найдена, он предполагает, что это не страница входа, и прекращает работу, возвращая исходный HTML.

2.  **Обработка ошибок входа**:
    *   Если на странице присутствует вызов JavaScript-функции `show_warn("...")`, фильтр расценивает это как ошибку авторизации (например, "Неверный пароль" или "Персонаж не найден").
    *   Он извлекает текст ошибки.
    *   С помощью `BeginInvoke` он передает этот текст в основной UI-поток для отображения пользователю (в C#-версии это `AppVars.MainForm.UpdateAccountError`).
    *   После этого он возвращает пустой HTML, чтобы скрыть стандартную страницу с ошибкой.

3.  **Автоматическая авторизация**:
    *   Если это страница входа и ошибок нет, фильтр **полностью игнорирует** полученный HTML.
    *   Он генерирует с нуля новую HTML-страницу, содержащую скрытую форму.
    *   В поля этой формы (`player_nick` и `player_password`) подставляются логин и пароль пользователя из `AppVars.Profile`.
    *   С помощью встроенного JavaScript (`document.ff.submit();`) эта форма немедленно отправляется на сервер (`./game.php`).
    *   Это полностью автоматизирует процесс входа, избавляя пользователя от необходимости вручную вводить данные.

4.  **Установка флага `WaitFlash`**:
    *   Сразу после генерации страницы для авто-входа, устанавливается флаг `AppVars.WaitFlash = true`. Это является сигналом для следующего обработчика (`GamePhp.process`) о том, что после входа может потребоваться обработка Flash-пароля.

## План портирования в Java

1.  **Создать `IndexCgi.java`** в пакете `ru.neverlands.abclient.postfilter`.
2.  **Реализовать метод `process`**:
    *   Метод будет принимать `byte[] array`.
    *   Реализовать проверку на наличие `auth_form`.
    *   Реализовать поиск и извлечение текста ошибки из `show_warn()`.
    *   Для передачи ошибки в UI необходимо будет использовать Android-специфичный механизм, например, `Handler` или `LocalBroadcastManager`, чтобы отправить сообщение в активную Activity/Fragment.
    *   Реализовать генерацию HTML для авто-входа. Вместо `HttpUtility.HtmlEncode` использовать `android.text.Html.escapeHtml`.
    *   Установить флаг `AppVars.WaitFlash = true`.
3.  **Интегрировать в `Filter.java`**:
    *   В `Filter.java` найти условие `address.startsWith("http://www.neverlands.ru/index.cgi")`.
    *   Вызывать из него `IndexCgi.process(array)`.
