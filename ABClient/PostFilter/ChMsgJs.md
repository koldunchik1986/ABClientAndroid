# Анализ ChMsgJs.cs

Файл `ChMsgJs.cs` является частью `PostFilter` и предназначен для модификации JavaScript-файла `/ch/ch_msg_v01.js` перед его отправкой клиенту. Основная цель — встроить в клиентский скрипт взаимодействие с хост-приложением (через `window.external`) и изменить стандартное поведение чата.

## Основные модификации

1.  **Фильтрация сообщений чата**:
    *   **Оригинал (JS):** `s += txt + "<BR>";`
    *   **Модификация (C#):** `s += window.external.ChatFilter(txt) + "<BR>";`
    *   **Назначение:** Каждое новое сообщение чата `txt` перед отображением проходит через функцию `ChatFilter`, определенную в основном коде приложения. Это позволяет фильтровать, изменять или логировать сообщения на стороне клиента.

2.  **Уведомление об обновлении чата**:
    *   **Оригинал (JS):** `,65000);`
    *   **Модификация (C#):** `, 65000); window.external.ChatUpdated()`);`
    *   **Назначение:** После обновления содержимого чата вызывается метод `ChatUpdated()` хост-приложения. Это позволяет приложению реагировать на обновление чата, например, для системных уведомлений.

3.  **Обработка кликов по никам**:
    *   **Оригинал (JS):** `login = login.replace ('%', '');`
    *   **Модификация (C#):** Заменяет эту строку на сложный блок кода, который:
        *   Фокусируется на поле ввода текста в фрейме `ch_buttons`.
        *   Анализирует текущий текст в поле ввода, чтобы определить, является ли он клановым (`%clan%`) или парным (`%pair%`) сообщением.
        *   В зависимости от контекста, подставляет в поле ввода отформатированную строку с ником пользователя, по которому кликнули (например, `%pair%<user_login>`).
    *   **Назначение:** Упрощает отправку личных, клановых и парных сообщений по клику на ник в чате.

4.  **Манипуляции с DOM**:
    *   Заменяет все атрибуты `alt` на `title`. Вероятно, для улучшения совместимости и отображения всплывающих подсказок в используемом веб-компоненте.
    *   Удаляет код, связанный с `scrollLeft` и `scrollTop`. Это может быть исправлением для конкретной реализации браузерного движка, чтобы избежать нежелательной прокрутки.

## План портирования в Java

1.  **Создать `ChMsgJs.java`**: В пакете `ru.neverlands.abclient.postfilter`.
2.  **Реализовать метод `process`**:
    *   Метод будет принимать `byte[]` (содержимое JS-файла).
    *   Конвертировать байты в строку, используя кодировку `windows-1251`.
    *   Выполнить все замены строк (`replace`), аналогично C#-версии.
    *   В Java `window.external` будет заменен на JavaScript-интерфейс, который будет вызывать соответствующие методы в Java-коде. Название интерфейса (например, `AndroidBridge`) будет использоваться вместо `window.external`.
    *   Конвертировать измененную строку обратно в `byte[]`.
3.  **Интегрировать в `Filter.java`**:
    *   В `Filter.java` найти условие `address.endsWith("/ch/ch_msg_v01.js")`.
    *   Вызывать из него `ChMsgJs.process(array)`.
