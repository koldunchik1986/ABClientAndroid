# Анализ FishAjaxPhp.cs

Файл `FishAjaxPhp.cs` является частью `PostFilter` и обрабатывает AJAX-ответы от сервера, приходящие после заброса удочки (`gameplay/ajax/fish_ajax.php`). Его основная задача — парсинг результатов рыбалки, расчет экономики и отображение подробной статистики для пользователя.

## Функциональность

1.  **Обработка ошибок**: В первую очередь, фильтр проверяет ответ на наличие стандартных ошибок рыбалки:
    *   "У Вас нет рыболовных снастей."
    *   "У Вас нет приманки..."
    *   "У Вас не хватает умения..."
    При обнаружении любой из этих ошибок, он вызывает `UpdateFishOff` в основном UI, чтобы остановить процесс авто-рыбалки.

2.  **Парсинг отчета (`FishReport`)**: Если ошибок нет, фильтр парсит строку ответа, которая содержит информацию о результате заброса. Он извлекает:
    *   Название пойманной рыбы.
    *   Количество улова и количество поклевок.
    *   Факт повышения умения "Рыбалка".

3.  **Расчет экономики и обновление состояния**:
    *   На основе извлеченных данных и жестко закодированных таблиц (цена/масса рыбы, цена/масса приманки), скрипт вычисляет финансовый результат (доход или убыток) от улова.
    *   Обновляет глобальные переменные, такие как `AppVars.Profile.FishUm` (умение рыбалки) и `AppVars.AutoFishNV` (общий доход/убыток за сессию).

4.  **Генерация отчетов для пользователя**: Скрипт генерирует несколько видов отчетов:
    *   **HTML-отчет**: Создается подробный HTML-блок, который заменяет оригинальный ответ сервера. Этот блок содержит всю статистику: улов, умение, изменение массы, остаток приманки, доход за сессию.
    *   **Отчет для трея**: Формируется краткая текстовая сводка для всплывающего уведомления в системном трее Windows.
    *   **Отчет для чата**: Если опция `FishChatReport` включена в настройках, формируется и отправляется сообщение в игровой чат с результатами.

5.  **Взаимодействие с UI**: Код активно использует `BeginInvoke` для асинхронного обновления различных элементов интерфейса `MainForm` (остановка рыбалки, обновление счетчика дохода, отправка сообщений в чат и т.д.).

## План портирования в Java

1.  **Создать `FishAjaxPhp.java`** в пакете `ru.neverlands.abclient.postfilter`.
2.  **Реализовать метод `process`**:
    *   Перенести логику проверки на ошибки.
    *   Создать вложенный метод `fishReport`, который будет выполнять основную работу.
3.  **Реализовать `fishReport`**:
    *   Перенести логику парсинга строки ответа.
    *   Для хранения данных о рыбе и приманке использовать `HashMap<String, FishData>` или аналогичную структуру.
    *   Реализовать расчет экономики.
    *   Реализовать генерацию HTML-отчета.
    *   Все вызовы `BeginInvoke` заменить на отправку событий в UI-поток. Например, можно использовать `LocalBroadcastManager` для отправки `Intent` с данными, которые `Activity` или `Fragment` сможет перехватить и обработать.
        *   `UpdateFishOff` -> `sendBroadcast(new Intent("ACTION_STOP_FISHING"))`
        *   `UpdateFishNV` -> `sendBroadcast(new Intent("ACTION_UPDATE_FISH_NV").putExtra("nv_change", ...))`
        *   `UpdateTrayBaloon` -> Создание Android Notification.
        *   `WriteMessageToChat` -> `sendBroadcast(new Intent("ACTION_SEND_CHAT_MESSAGE").putExtra("message", ...))`
4.  **Интегрировать в `Filter.java`**: В `Filter.java` найти условие `address.startsWith("http://www.neverlands.ru/gameplay/ajax/fish_ajax.php")` и вызывать из него `FishAjaxPhp.process(array)`.
